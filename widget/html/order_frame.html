<!DOCTYPE html>
<html>

<head>
      <link rel="shortcut icon" href="../image/chao.ico" />
    <meta charset="utf-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0" />
    <meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
    <title>下单Frame</title>
    <script src="../script/commonjs.js"></script>

    <style>
    html,
    body {
        padding:0;
        margin:0;
        height: 100%;
        background-color: #f0f0f0;
    }
    
    .address {
        position: relative;
        box-sizing: border-box;
        width: 100%;
        height: auto;
        margin-bottom: 8px;
        padding: 8px 16px;
        background-color: #fff;
        margin-top: 6px;
    }
    
    .address .icon {
        position: absolute;
        top: 21px;
        left: 16px;
        width: 19px;
        height: 24px;
        background-image: url(../image/dizhi.png);
        background-repeat: no-repeat;
        background-size: auto 20px;
        background-position: center center;

    }
    
    .address .sign {
        display: none;
        position: absolute;
        top: 45px;
        left: 8px;
        width: 35px;
        height: 14px;
        line-height: 14px;
        font-size: 12px;
        color: #444;
        text-align: center;
    }
    
    .address .sign-1 {
        display: block;
    }
    
    .address .info {
        position: relative;
        box-sizing: border-box;
        padding-left: 36px;
        padding-right: 28px;
        width: 100%;
        height: auto;
    }
    
    .address .info .top {
        position: relative;
        box-sizing: border-box;
        width: 100%;
        height: 32px;
        color: #444;
        line-height: 32px;
        font-size: 14px;
    }
    
    .address .info .top .consignee {
        display: inline;
        width: auto;
    }
    
    .address .info .top .mobile {
        display: inline;
        width: auto;
        margin-left: 16px;
    }
    
    .address .info .bottom {
        position: relative;
        width: 100%;
        min-height: 32px;
        line-height: 32px;
        color: #888;
        font-size: 14px;
    }
    
    .address .info .bottom .type {
        display: inline;
        width: auto;
        color: black;
        font-weight: bolder;
    }
    
    .address .info .bottom .text {
        display: inline;
        width: auto;
    }
    
    .address .arrow {
        position: absolute;
        right: 16px;
        top: 32px;
        width: 8px;
        height: 16px;
        background-image: url(../image/item_user_address_right.png);
        background-repeat: no-repeat;
        background-size: 8px 16px;
        background-position: right center;
    }
    
    .order {
        position: relative;
        width: 100%;
        height: auto;
        margin-bottom: 50px;
    }
    
    .order .title {
        position: relative;
        box-sizing: border-box;
        padding-left: 40px;
        width: 100%;
        height: 44px;
        line-height: 44px;
        font-size: 16px;
        text-align: left;
        color: #444;
        background-color: #fff;
        background-image: url(../image/dindan.png);
        background-repeat: no-repeat;
        background-size: auto 20px;
        background-position: 16px center;
    }
    
    .order .icon-panel {
        position: relative;
        display: -webkit-box;
        display: -webkit-flex;
        display: flex;
        -webkit-box-orient: horizontal;
        -webkit-flex-flow: row;
        flex-flow: row;
        box-sizing: border-box;
        padding: 8px 16px;
        width: 100%;
        height: 80px;
        background-color: #f1f5f8;
    }
    
    .order .icon-panel .icon {
        width: 64px;
        height: 64px;
        border-radius: 8px;
    }
    .order .icon-panel .icon img{
        width: 64px;
        height: 100%;
        border-radius: 10px;
    }
    
    .order .icon-panel .info {
        position: relative;
        -webkit-box-flex: 1;
        -webkit-flex: 1;
        flex: 1;
        box-sizing: border-box;
        padding-left: 16px;
    }
    
    .order .icon-panel .info .top {
        position: relative;
        box-sizing: border-box;
        padding-top: 8px;
        width: 100%;
        height: 32px;
        font-size: 16px;
        color: #444;
        text-align: left;
    }
    
    .order .icon-panel .info .bottom {
        position: relative;
        box-sizing: border-box;
        padding-bottom:2px;
        width: 100%;
        height: 32px;
        font-size: 16px;
        color: #444;
        text-align: left;
    }
    
    .order .icon-panel .right {
        box-sizing: border-box;
        width: 40px;
        height: 64px;
        padding-top: 50px;
        font-size: 14px;
        text-align: right;
    }
    
    .order .row {
        position: relative;
        box-sizing: border-box;
        padding-left: 16px;
        padding-right: 16px;
        width: 100%;
        height: 44px;
        line-height: 44px;
        font-size: 16px;
        margin-bottom: 1px;
        background-color: #fff;
    }
    
    .order .row .text {
        position: relative;
        width: 100%;
        height: 44px;
        text-align: left;
        color: #444;
    }
    
    .order .row .value {
        position: absolute;
        box-sizing: border-box;
        top: 0;
        right: 16px;
        width: 100%;
        height: 44px;
        text-align: right;
        color: #444;
    }
    
    .order .row .value-1 {
        padding-right: 20px;
        background-image: url(../image/arrow_right.png);
        background-repeat: no-repeat;
        background-size: 12px 20px;
        background-position: right center;
        color: black;
    }
    
    .order .row .value-2 {
        color: black;
    }
    
    .order .row-1 {
        position: relative;
        box-sizing: border-box;
        padding-left: 16px;
        padding-right: 16px;
        width: 100%;
        height: 44px;
        line-height: 44px;
        text-align: right;
        font-size: 16px;
        background-color: #fff;
    }
    
    .color {
        color: black;
    }
    
  
  
    
    .highlight {
        opacity: 0.7;
    }
    .info .description {
        /*margin-bottom: 3px;*/
        display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
        width: 100%;
        /*height: 16px;*/
        font-size: 13px;
        color: #9d9d9d;
        margin-top: 10px;
    }
    #footer{
      display: -webkit-box;
      display: -webkit-flex;
      display: flex;
      -webkit-box-orient: horizontal;
      -webkit-flex-flow: row;
      flex-flow: row;
      width: 100%;
      height: 50px;
      background-color: #fff;
      position: fixed;
      left: 0px;
      bottom: 0px;

  }

  #footer .panel {
    -webkit-box-flex: 1;
    -webkit-flex: 1;
    flex: 1;
    height: 50px;
    box-sizing: border-box;
    padding-left: 16px;
    line-height: 50px;
    color: #000;
    font-size: 18px;
    text-align: left;
}

#footer .buy {
    width: 66px;
    height: 100%;
    margin-right: 12px;
    
}
#footer .buy .buybtn{
    margin-top: 6px;
    width: 100%;
    height: 39px;
    background: #FE2640;
    border-radius: 25px;
    text-align: center;
    color: #FFFFFF;
    line-height: 39px;
}

#colorandsize{
    font-size: 12px;
    /*margin-left: 2px;*/
    color: #888;
    /*margin-top: 0px;*/
    /*border:1px solid red;*/
    width: 100px;
    display: inline-block;
    height: 18px;
}
header{
    width: 100%;
    height: 40px;
    background: white;
    margin: 0px;
    position: relative;
}
header .back {
    position: absolute;
    top: 0;
    left: 0;
    width: 40px;
    height: 40px;
    z-index: 2;
}

header .back img {
    margin-top: 5px;
    margin-left: 4px;
    width: 28px;
    height: 30px;
}
header a {
 display: block;
 text-align: center;
 line-height: 40px;
 font-size: 16px;
 font-weight: bold;

}
#wareprice{
    /*border: 1px solid red;*/
    height: 18px;
    font-size: 13px;
    width:50px;
    /*border:1px solid red;*/
    display:inline-block;
}
</style>
</head>

<body>
    <header>
     <div class="back" tapmode onclick="javascript:history.back(-1);">
        <img src="../image/back.png">
    </div>
    <a>购买进行中</a>

</header>

<section class="address"  id="address">
    <div class="icon">
    </div>
    <div class="info">
        <div class="top">
            <div class="consignee" id="shouhuoren">收货人：...</div>
            <div class="mobile" id="mobile">...</div>
        </div>
        <div class="bottom">
            <div class="type" id="type">【...】</div>
            <div class="text" id="text">...</div>
        </div>
    </div>
</section>
<section class="order">
    <div class="title">订单信息</div>
    <div class="icon-panel">
        <div class="icon" id="icon">
            <img src="../image/order_ware.gif" id="image" alt="">
        </div>
        <div class="info">
            <!-- <div class="top" id="warename"></div> -->
            <div class="description" id="description"></div>
            <div class="bottom" id="wareprice"></div>
            <div class="bottom" id="colorandsize">.../...</div>

        </div>
    </div>
    <div class="row">
        <div class="text">商品金额:</div>
        <div class="value value-2" id="price1">+&nbsp;</div>
    </div>
    <div class="row">
        <div class="text">运费：</div>
        <div class="value value-2">&nbsp;运费平台付</div>
    </div>
    <div class="row">
        <div class="text">VIP优惠：</div>
        <div class="value value-2" id="viptext">-&nbsp;￥0.0</div>
    </div>
    <div class="row">
        <div class="text">返现金(商品中扣除):</div>
        <div class="value value-2" id="fanqian">&nbsp;￥0.0</div>
    </div>
    <div class="row-1">
        <div class="value value-2">实付款：&nbsp;<span class="color" id="price2"></span></div>
    </div>
</section>
<footer id="footer">
    <div class="panel" id="price3">总金额:</div>
    <div class="buy" onclick="yesadd()">
        <div class="buybtn">购买</div>
    </div>
</footer>
<script type="text/javascript">
    var price3;
    var dizhinull;
    var loading;
    var jiage;
    var myDate = new Date();
    var Y=myDate.getFullYear();
    var M=myDate.getMonth()+1;
    var D=myDate.getDate();  
    var h=myDate.getHours();    
    var m=myDate.getMinutes();
    var s=myDate.getSeconds(); 
    var addInfo = {
        dindantypeid:'5c2a3991af3114d73d9ddfc2',
        addtime:Y+'-'+M+'-'+D+' '+h+':'+m+':'+s,
    };
    var types = ['公司', '住宅', '学校', '其它'];
    apiready = function(){
        getware();
    }
        
    

    
    function getware(){
        dialog('订单加载中');
        $('#colorandsize').html(api.pageParam.size+'/'+ api.pageParam.color)
        // alert(api.pageParam.size)
        var params={
            fields:{},
            fields: {},
            where: {
                id:api.pageParam.wareId
            },
            skip:0
        }
        apigetajax('http://d.apicloud.com/mcm/api/ware',params,function(ret){
            if (ret){
                jiage=ret[0].price;
                updateWare(ret);
                addInfo.size=api.pageParam.size;
                addInfo.color=api.pageParam.color;
                addInfo.wareid=ret[0].id;
                addInfo.description=ret[0].description;
                addInfo.warename=ret[0].name;
                addInfo.url=ret[0].thumbnail;
                addInfo.shangjia=ret[0].shangjia;
                addInfo.wareTypeId=ret[0].wareTypeId;
            }
        });

    }
    function updateWare(_data){
        var warename=$('#warename');
        var wareprice=$('#wareprice');
        var price1=$('#price1');
        var image=$('#image');    
        var description=$('#description');
        warename.html(_data[0].name);
        description.html(_data[0].description);
        wareprice.html('￥'+_data[0].price);
        price1.html('￥'+_data[0].price);
    // price2.innerHTML='￥'+_data[0].price;
    image.attr('src',_data[0].thumbnail);
    console.log(_data[0].thumbnail);
    vip(_data[0].price);
   
    
}
function vip(dataprice){

  var usernameinfo=$api.getStorage('userInfo');;
  var price2=$('#price2');
  price3=$('#price3');
  var viptext=$('#viptext');
  var fanqian=$('#fanqian');
  var vipprice=dataprice * 0.95;
  var ceilprice =Math.round(vipprice);
    // console.log(ret);
    addInfo.username=usernameinfo.username;
    addInfo.userid=usernameinfo.id;
    // return;
    if (jiage>29) {


        if (usernameinfo.vip==1) {
            viptext.html('9.5折'+'(-'+(dataprice-ceilprice)+'元)');
            var fan=Math.round(ceilprice*0.03);
            price2.html('￥'+(ceilprice-fan));
            price3.html('总金额：'+(ceilprice-fan));
            fanqian.html(fan);
            addInfo.price=ceilprice-fan;
        } else{
          viptext.html('分享应用获取vip打9.5折');
          var fan=Math.round(dataprice*0.03);
          price2.html('￥'+(dataprice-fan));
          price3.html('总金额：'+(dataprice-fan));
          fanqian.html(fan);
          addInfo.price=dataprice-fan;
      }

  }else{
      viptext.html('商品价格大于30元即可打折');
      var fan=Math.round(dataprice*0.03);
      price2.html('￥'+(dataprice-fan));
      price3.html('总金额：'+(dataprice-fan));
      fanqian.html(fan);
      addInfo.price=dataprice-fan;

  }
  // loading=$('#loading');
  // loading.addClass("hidden").removeClass("show");
  getaddress();




}
function getaddress(){
    
    var userInfo=$api.getStorage('userInfo');
    var params={
     default:1,
     userId:userInfo.id,
 }
 getajax(url+'getdefaultaddress',params,function(ret){  
    dl.close();
     if (ret.code==200) {
        // console.log(ret.data);
        dizhinull=ret.data[0];
           var data=ret.data[0];
        addInfo.addressid=data.id;
        addInfo.address=data.address;
        addInfo.shoppingname=data.name;
        addInfo.house=data.house;
        addInfo.addresstype=data.type;
        addInfo.mobile=data.mobile; 

        updateaddress(data);

        
        }else if (ret.data[0]==null){
            toast('请完善收货地址','center',2000)
              
              return;

        }
       

    

})

}


function updateaddress(_data){
     
    mobile=_data[0];
    var shouhuoren=$('#shouhuoren');
    var mobile=$('#mobile');
    var type=$('#type');
    var text=$('#text');
    shouhuoren.html('收货人:'+_data.name);
    mobile.html(_data.mobile);
    type.html('['+ types[_data.type] +']');
    text.html(_data.address +'/'+_data.house);
   
}


function yesadd(){ 
    if(dizhinull==null){
      // toast('请完善收货地址','center',2000)
      api.toast({
          msg: '请完善收货地址'
      });
     return;

 }
  var notice = $(document).dialog({
            type : 'notice',
            infoIcon: '../image/icon/loading.gif',
            infoText: '正在生成订单...'
        });

 postajax(url+'addshopping',addInfo,function(ret){
    if (ret.code==200) {
          notice.update({
                infoIcon: '../image/icon/success.png',
                infoText: '下单成功！！',
                autoClose: 1500
            });
          setTimeout(function(){
              // body...
              api.closeWin({
                  name: 'order'
              });
          },1000)
         
          // setTimeout(function(){
            // window.location.href="./dindan_frame.html?"+window.btoa(encodeURI('nav=0'));
             
            api.openWin({
                name: 'dindan',
                url: './dindan.html',
                pageParam: {
                    nav:0
                },
                animation:{
                    type:'fade'
                }
            });
          
          // },2000);
    }

});

}
</script>
</body>




</html>
