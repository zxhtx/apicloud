<!doctype html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,initial-scale=1.0,width=device-width" />
  <meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
  <title>Hello APP</title>
  <link rel="stylesheet" type="text/css" href="./css/api.css" />
  <style type="text/css">
  html,
  body {
    height: 100%;
    background-color: #fff;
  }

  .wrap {
    display: -webkit-box;
    -webkit-box-orient: vertical;
    -webkit-flex-flow: column;
  }

  header {
    height: 40px;
    width: 100%;
    text-align: center;
    color: #fff;
    line-height: 44px;
    font-size: 20px;
  }
  .home-search {
    position: absolute;
    left: 9px;
    right: 9px;
    top: 2px;
    bottom: 2px;
    height: 36px;
    line-height: 36px;
    background-color:black;
    border-radius: 34px;
    color: white;
    font-size: 14px;
  }

  .home-search>img {
    height: 20px;
    padding-top: 7px;
    padding-left: 10px;
    padding-right: 10px;
    vertical-align: top;
  }

</style>
</head>

<body class="wrap">
<!--   <header>
    <div class="home-search open-win" tapmode onclick="opensearch()">
      <img src="./image/search_home.png">
      <span>搜索其实很简单</span>
    </div>
  </header> -->
</body>
<script type="text/javascript" src="./script/api.js"></script>
<script type="text/javascript" src="./script/SHA1.js"></script>
<script type="text/javascript">
  var headerH;
  var clipBoard;
  var dialogBox ;
  var status = false;

  apiready = function() {

        // var header = $api.dom('header'); // 获取 header 标签元素
        // headerH=$api.offset(header).h;
        fnNVTabBar_open();
        kouling();
        fnInitListener();
        initWareTypeList();
        initShoppingTypeList();
        // openmain();
        // openretui()
      };
      function kouling(){
      var re=/^(?:http(s)?:\/\/)?[\w.-]+(?:\.[\w\.-]+)+[\w\-\._~:/?#[\]@!\$&'\*\+,;=.]+$/;
        clipBoard= api.require('clipBoard');
        api.addEventListener({
          name: 'resume'
        }, function(ret, err) {

          clipBoard.get(function(ret, err) {
           if (ret && ret.value && ret.value != "" && ret.type =="url") {

            if(status==true){
              return;
            }else{
              // alert(ret);

              if(re.test(ret.value) && ret.value.match(/chaodashe.com/)){
                // alert(1);
                alertkouling(ret.value);
              }
              
            }

            clipBoard.set({value: ""}, function() {})
          }
        });
         // alert(1)
       });

        clipBoard.get(function(ret, err) {
          if (ret && ret.value && ret.value != "" && ret.type =="url") {
               // alert(ret);
               if(re.test(ret.value) && ret.value.match(/chaodashe.com/)){
                // alert(1);
                  alertkouling(ret.value);
                clipBoard.set({value: ""}, function() {})
               }
          
          }
        });

      }

      function alertkouling(val){
        status = true;
        dialogBox = api.require('dialogBox');
        dialogBox.alert({
          texts: {
            title: '是否根据链接查找商品',
            content:val ,
            leftBtnTitle: '取消',
            rightBtnTitle: '确认'
          },
          styles: {
            bg: '#fff',
            w: 300,
            corner:2,
            title: {
              marginT: 20,
              icon: 'widget://res/gou.png',
              iconSize: 40,
              titleSize: 14,
              titleColor: '#000',
              bg:'#F14E7D',
            },
            content: {
              color: '#000',
              size: 14
            },
            left: {
              marginB: 7,
              marginL: 20,
              w: 130,
              h: 35,
              corner: 2,
              color: '#000',
              bg: 'white',
              size: 18
            },
            right: {
              marginB: 7,
              marginL: 10,
              w: 130,
              h: 35,
              corner: 2,
              bg: 'white',
              color: '#F14E7D',
              size: 18
            }
          }
        }, function(ret) {
          if (ret.eventType == 'left') {
            status = false;
            dialogBox.close({
              dialogName: 'alert'
            });
             
          }else{
            var url=val;
            var arr=url.split('/');
            // alert(arr[arr.length-1].split('_')[0]);
            var canshu=window.atob(decodeURI(arr[arr.length-1].split('?')[1]));
            
            var wintype=arr[arr.length-1].split('_')[0];
            var wname=canshu.split('=')[0];
            var wvalue=canshu.split('=')[1];
            // var canshu=arr[1].substring(4);
            // alert(wvalue)
            https://chaodashe.com/html/Dressingdetails_frame.html?YXJ0aWNsZWlkPTc1
            status = false;
            if (wintype=='ware'){

              api.openWin({
                name: 'ware',
                url: './html/ware.html',
                pageParam: {
                  wareId:wvalue,
                },
                animation:{
                  type:'fade'
                }
              });
            }else if(wintype=='Dressingdetails'){


              api.openWin({
                name: 'Dressingdetails',
                url: './html/Dressingdetails.html',
                pageParam: {
                  articleid:wvalue,
                },
                animation:{
                  type:'fade'
                }
              });
            

            }else{
              api.toast({
                msg: '链接不是本站链接',
                duration: 2000,
                location: 'bottom'
              });
            }
            
            dialogBox.close({
              dialogName: 'alert'
            });
          }
        });
      }
  
      function fnInitListener() {
        var flag = false;
        api.addEventListener({
          name: 'keyback'
        }, function(ret, err) {
          if (false == flag) {
            api.toast({
              msg: '再按一次退出',
              duration: 2000,
              location: 'bottom'
            });
            flag = true;
            setTimeout(function() {
              flag = false;
            }, 2000);
          } else {
            api.closeWidget({
              silent: true
            });
          }
        });


      };

      function fnNVTabBar_open() {
        var NVTabBar = api.require('NVTabBar');
        NVTabBar.open({
          styles: {
            bg: '#fff',
            h: 54,
            dividingLine: {
              width: 1,
              color: '#E2E2E2'
            },
            badge: {
              bgColor: '#f00',
              numColor: '#000',
              size: 6.0,
              centerY: 2
            }
          },
          items: [
          {
            w: api.winWidth / 4.0,
            iconRect: {
              w: 25.0,
              h: 25.0,
            },
            icon: {
              normal: 'widget://image/footer/shizhuang.png',
              highlight: 'widget://image/footer/shizhuang_act.png',
              selected: 'widget://image/footer/shizhuang_act.png'
            },
            title: {
              text: '潮搭社',
              size: 12.0,
              normal: '#696969',
              selected: '#000',
              marginB: 6.0,
            }
          },
          {
            w: api.winWidth / 4.0,
            iconRect: {
              w: 25.0,
              h: 25.0,
            },
            icon: {
              normal: 'widget://image/footer/home.png',
              highlight: 'widget://image/footer/home_act.png',
              selected: 'widget://image/footer/home_act.png'
            },
            title: {
              text: '商城',
              size: 12.0,
              normal: '#696969',
              selected: '#000',
              marginB: 6.0,
            }
          },
          {
            w: api.winWidth / 4.0,
            iconRect: {
              w: 25.0,
              h: 25.0,
            },
            icon: {
              normal: 'widget://image/footer/groupbuy.png',
              highlight: 'widget://image/footer/groupbuy_act.png',
              selected: 'widget://image/footer/groupbuy_act.png'
            },
            title: {
              text: '热推短视频',
              size: 12.0,
              normal: '#696969',
              selected: '#eb4f38',
              marginB: 6.0
            }
          },{
            w: api.winWidth / 4.0,
            iconRect: {
              w: 25.0,
              h: 25.0,
            },
            icon: {
              normal: 'widget://image/footer/me.png',
              highlight: 'widget://image/footer/me_act.png',
              selected: 'widget://image/footer/me_act.png'
            },
            title: {
              text: '我的',
              size: 12.0,
              normal: '#696969',
              selected: '#eb4f38',
              marginB: 6.0
            }
          }],
          selectedIndex: 0
        }, function(ret, err) {
          if (ret) {

            if (ret.eventType == "show") {
              openDressing();
            }
            if (ret.eventType == "click" && ret.index == 0) {
             openDressing();
            }
            if (ret.eventType == "click" && ret.index == 2) {
             openretui();
           }
           if (ret.eventType == "click" && ret.index == 3) {
            openmy();
          }
          if (ret.eventType == "click" && ret.index == 1) {
            openmain();
         }

       }
     });
      }
      function openDressing(){
        api.openFrame({
          name: 'chaodashe_frame',
          url: './html/chaodashe_frame.html',
          rect: {
            x: 0,
            y: 0,
            w: api.winWidth,
            h: api.winHeight-54
          },
          bounces: false,
          animation:{
            type:'fade'
          }

        });
        hiddennewvideo();
        hiddenhome();
        hiddenmy();
      }
      function openmain(){
        api.openFrame({
          name: 'home_frame',
          url: './html/home_frame.html',
          rect: {
            x: 0,
            y: 0,
            w: api.winWidth,
            h: api.winHeight-54
          },
          pageParam: {
            name: 'test'
          },
          bounces: false,
          animation:{
            type:'fade'
          }

        });
        // var NVTabBar = api.require('NVTabBar');
        // NVTabBar.bringToFront();
        hiddennewvideo();
        hiddenmy();
        hiddenDressing();
      }
      function openretui(){
       api.openFrame({
        name: 'newvideo',
        url: './html/newvideo.html',
        rect: {
          x: 0,
          y: 0,
          w: api.winWidth,
          h: api.winHeight-54
        },
        bounces: false,
        pageParam: {
          name: 'test'
        },
        animation:{
          type:'fade'
        }

      });
       // var NVTabBar = api.require('NVTabBar');
       // NVTabBar.bringToFront();
       hiddenhome();
       hiddenmy();
       hiddenDressing();

     }
     function openmy(){
       api.openFrame({
        name: 'my_frame',
        url: './html/my_frame.html',
        rect: {
          x: 0,
          y: 0,
          w: api.winWidth,
          h: api.winHeight-54
        },
        bounces: false,
        pageParam: {
          name: 'test'
        },
        animation:{
          type:'fade'
        }

      });
       
       hiddenhome();
       hiddennewvideo();
       hiddenDressing();


     }

     function hiddenhome(){
      api.setFrameAttr({
        name: 'home_frame',
        hidden: true
      });
      
    }
    function hiddennewvideo(){
      api.setFrameAttr({
        name: 'newvideo',
        hidden: true
      });
      
    }

    function hiddenmy(){
     api.setFrameAttr({
      name: 'my_frame',
      hidden: true
    });

     
     
   }
   function hiddenDressing(){
    api.setFrameAttr({
      name: 'Dressing_frame',
      hidden: true
    });

  }

  function initWareTypeList() {

    var now = Date.now();
      //5FB51794-FCDC-1FE9-19E0-xxxxxxxxxxxx换成自己appkey
      var appKey = SHA1("A6099267504667"+"UZ"+"8FC0173C-B395-B797-D516-7A6CD23939B3"+"UZ"+now)+"."+now

    // 获取上一次的商品分类列表
    // var wareTypeList = $api.getStorage('wareTypeList');

    // 如果没有商品分类列表，则使用默认的商品分类列表
    // if (!wareTypeList) {
      var params = {
        fields: {
          createdAt: false,
          updatedAt: false
        },
        where: {},
        skip: 0,
        limit: 10
      }
      params = $api.jsonToStr(params);
      api.ajax({
        url: 'http://d.apicloud.com/mcm/api/wareType?filter=' + params,
        method: 'get',
        headers: {
          "X-APICloud-AppId": "A6099267504667",
          "X-APICloud-AppKey":   appKey
        }
      }, function(ret, err) {
        if (ret) {
            // 存储商品分类列表到本地
            $api.setStorage('WareTypeList', ret);
          } else {
            api.toast({
              msg: '更新商品分类列表失败',
              duration: 2000,
              location: 'bottom'
            });
          }
        });

    // }

  }


  function initShoppingTypeList() {

    var now = Date.now();
      //5FB51794-FCDC-1FE9-19E0-xxxxxxxxxxxx换成自己appkey
      var appKey = SHA1("A6099267504667"+"UZ"+"8FC0173C-B395-B797-D516-7A6CD23939B3"+"UZ"+now)+"."+now

    // 获取上一次的商品分类列表
    var dindantypeList = $api.getStorage('dindantypeList');

    // 如果没有商品分类列表，则使用默认的商品分类列表
    if (!dindantypeList) {
      var params = {
        fields: {
          createdAt: false,
          updatedAt: false
        },
        where: {},
        skip: 0,
        limit: 10
      }
      params = $api.jsonToStr(params);
      api.ajax({
        url: 'http://d.apicloud.com/mcm/api/dindantype?filter=' + params,
        method: 'get',
        headers: {
          "X-APICloud-AppId": "A6099267504667",
          "X-APICloud-AppKey":   appKey
        }
      }, function(ret, err) {
        if (ret) {
            // 存储商品分类列表到本地
            // alert($api.jsonToStr(ret))
            $api.setStorage('dindantypeList', ret);
          } else {
            api.toast({
              msg: '更新商品分类列表失败',
              duration: 2000,
              location: 'bottom'
            });
          }
        });

    }

  }
</script>

</html>
