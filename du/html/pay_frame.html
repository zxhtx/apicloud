<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
	<title>title</title>
	<link rel="stylesheet" type="text/css" href="../css/api.csss"/>
	<style>
	.pay{
		width: 100%;
		height: 220px;

	}
	.weixin{
		width: 47%;
		height: 220px;
		border: 2px solid black;
		border-radius: 5px;
		display: inline-block;
		float: left;
	}
	.weixin img{
		height: 180px;
		width: 100%
	}
	.weixin span{
		margin-left: 50px
	}
	.zhipay{
		width: 47%;
		height: 220px;
		border: 2px solid black;
		border-radius: 5px;
		float: right;
	}
	.zhipay img{
		height: 180px;
		width: 100%
	}
	.zhipay span{
		padding-left:40px; 
	}
	.text{
		text-align: center;
	}
	.upload{
		width: 100px;
		height: 120px;
		margin: 0 auto;
		margin-top: 100px;
	}
	.upload img{
		width: 100%;
		height: 100px;
	}
</style>
</head>
<body>
	<div class="pay">
		<div class="weixin" tapmode onclick="saveimg(1)">
			<span>微信支付</span>
			<img src="../image/weixin.png">
		</div>
		<div class="zhipay"  tapmode onclick="saveimg(2)">
			<span>支付宝支付</span>
			<img src="../image/zhipay.png">
		</div>
		<p class="text">点击图片即可保存</p>
	</div>
	<div class="upload" tapmode onclick="setpriceimg()">
		<img src="../image/upload.png" alt="">
		<p class="text">上传支付截图</p>
	</div>
</body>
<script type="text/javascript" src="../script/api.js"></script>
<script type="text/javascript" src="../script/SHA1.js"></script>
<script type="text/javascript">
	apiready = function(){

	};
	function saveimg(_data){
		if (_data==1) {
			api.download({
				url : 'http://a8b2ba6ef61d32f2d7d9.test.upcdn.net/apicloud/b065a2dc1de359323fc379c29996dfd5.png',
				savePath : 'fs://iamge/weixinpay.png'
			}, function(ret, err) {
				if (ret) {
					if (ret.state == 1) {
						api.saveMediaToAlbum({
							path : 'fs://iamge/weixinpay.png'
						}, function(ret, err) {
							if (ret && ret.status) {
								api.toast({
									msg: '保存成功',
									duration: 2000,
									location: 'bottom'
								});
							} else {
								api.toast({
									msg: '保存失败',
									duration: 2000,
									location: 'bottom'
								});
							}
						});
					}
				} 
			});
		}else{
			api.download({
				url : 'http://a8b2ba6ef61d32f2d7d9.test.upcdn.net/apicloud/88a0a06a2a5d02fdf061d4700c32fdad.png',
				savePath : 'fs://iamge/zhifubaopay.png'
			}, function(ret, err) {
				if (ret) {
					if (ret.state == 1) {
						api.saveMediaToAlbum({
							path : 'fs://iamge/zhifubaopay.png'
						}, function(ret, err) {
							if (ret && ret.status) {
								api.toast({
									msg: '保存成功',
									duration: 2000,
									location: 'bottom'
								});
							} else {
								api.toast({
									msg: '保存失败',
									duration: 2000,
									location: 'bottom'
								});
							}
						});
					}
				} 
			});

		}
		

	}
	function setpriceimg(){
		api.actionSheet({
			title: '选择',
			cancelTitle: '取消',
			buttons: ['拍照','相册']
		}, function(ret, err){
			if( ret ){
				var sourceTypes=['camera','album']
				if (ret.buttonIndex == (sourceTypes.length + 1)) {
					return;
				}
				api.getPicture({
					sourceType: sourceTypes[ret.buttonIndex-1],
					allowEdit: true,
					quality: 100,
					targetWidth: 600,
					targetHeight: 600,
					saveToPhotoAlbum: false
				}, function(ret, err){ 
					if(ret){
						uploadAtavar(ret.data);
					}else{
						api.toast({
							msg: err.msg,
							duration: 2000,
							location: 'bottom'
						});
					}
				});

			}else{
				api.toast({
					msg: err.msg,
					duration: 2000,
					location: 'bottom'
				});
			}
		});

	}
	function uploadAtavar(_data){

		var now = Date.now();
		var appKey = SHA1("A6099267504667"+"UZ"+"8FC0173C-B395-B797-D516-7A6CD23939B3"+"UZ"+now)+"."+now;
		api.ajax({
			url: 'https://d.apicloud.com/mcm/api/file',
			method: 'post',
			data: {
				values: { 
					filename: 'icon'
				},
				files: { 
					file: _data
				}
			},
			headers: {
				"X-APICloud-AppId": "A6099267504667",
				"X-APICloud-AppKey":   appKey
			},
		},function(ret, err){
			if (ret) {
				updateUserAtavar(ret)
			} else {
				api.toast({
					msg: err.msg,
					duration: 2000,
					location: 'bottom'
				});
			}
		});
	}
	function updateUserAtavar(_data){
    // alert($api.jsonToStr(api.pageParam.ware))
    var ware=api.pageParam.ware;

    var now = Date.now();
    var appKey = SHA1("A6099267504667"+"UZ"+"8FC0173C-B395-B797-D516-7A6CD23939B3"+"UZ"+now)+"."+now;
    var userInfo=$api.getStorage('userInfo');
    api.ajax({
    	url: 'https://d.apicloud.com/mcm/api/shoppinginformation/'+ware.id,
    	method: 'put',
    	headers: {
    		"X-APICloud-AppId": "A6099267504667",
    		"X-APICloud-AppKey":   appKey,
    		"Authorization":userInfo.id
    	},
    	data: {
    		values: { 
    			priceimg:_data.url,
    			dindantypeid:'5c2a39a2af3114d73d9ddfc3'
    		}

    	}
    },function(ret, err){
    	if (ret) {
    		if (ret.priceimg) {
    			api.sendEvent({
    		    name: 'updatedindantype',
    		});
    		api.closeWin()
    		}
    	} else {
    		api.toast({
    			msg: err.msg,
    			duration: 2000,
    			location: 'bottom'
    		});
    	}
    });
}   


</script>
</html>