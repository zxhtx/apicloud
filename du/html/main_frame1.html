<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0" />
  <title>title</title>
  <link rel="stylesheet" type="text/css" href="../css/api.css" />
  <style>
  html,
  body {
    background-color: #F0F0F0;
  }

  #list {
    position: relative;
    width: 100%;
    /*padding: 12px;*/


  }

  #list>.card {
    position: absolute;
    background-color: white;
    width: calc((100% - 36px)/2);
    margin-left: 6px;
    margin-top: 6px;

    margin-bottom: 18px;
    border-radius: 22px 26px 0px 29px;

  }

  .card>img{
    width: 100%;
    display: block;
    border-radius: 10px 10px 0px 24px;
  }
  .description{
    padding-left: 8px;
    font-size: 13px;
    
  }
  .price{
    position: relative;
    height: 38px;
    color: #FF2900;
    line-height: 39px;
    padding-left:12px;
    font-size: 16px;
    /*border: 1px solid red;*/

  }
  .price span{
    position: absolute;
    right: 1px;
    line-height: 38px;
    font-size: 12px;
    color: black;

  }
  .card .add{
   position: absolute;
   bottom: 0;
   right: 6;
   width: 28px;
   height: 28px;
   /*padding-bottom: 10px;*/
 }
 .card .add img{
  width: 100%;

}



</style>
</head>

<body>
  <div id="list">

  </div>
</body>

<script type="text/javascript" src="../script/api.js"></script>
<script type="text/javascript" src="../script/SHA1.js"></script>
<script type="text/javascript" src="../script/doT.min.js"></script>
<script type="text/javascript" src="../script/zepto/jquery.min.js"></script>
<script type="text/javascript" src="../script/jquery.lazyload.min.js"></script>
<script type="text/javascript" src="../script/pinterest_grid.js"></script>


<script type="text/javascript">

  var flowerid ;
  var activity ;
  var wareTypeList;
  var skip=0;
  var LIMIT=12;


  apiready = function() {
   init();
   getWareList();
   initEventListenter();
   initRefresh();



 };

 function init(){
   wareTypeList=$api.getStorage('WareTypeList');

 }
 function openWareWin(_wareId){

  api.openWin({
    name: 'ware',
    url: './ware.html',
    pageParam: {
      wareId: _wareId
    },
    animation: {
      type: "fade"
    }
  });

}

function getWareList(_LoadMore){

  if (_LoadMore) {

  }else{
   activity = api.require('UILoading');
   activity.flower({
    center: {
      x: api.winWidth/2,
      y: api.winHeight/2
    },
    mask:'rgba(20,0,0,0.5)',
    size: 30,
    // fixed: true,

  }, function(ret) {
    flowerid=ret.id;
  });
 }




 var now = Date.now();
      //5FB51794-FCDC-1FE9-19E0-xxxxxxxxxxxx换成自己appkey
      var appKey = SHA1("A6099267504667"+"UZ"+"8FC0173C-B395-B797-D516-7A6CD23939B3"+"UZ"+now)+"."+now
      if (_LoadMore) {
        skip+=LIMIT;
      }else{

        skip=0;
      }
      var params={
        fields:{},
        fields: {},
        where: {
          wareTypeId: wareTypeList[2].id
        },
        skip:skip,
        limit:LIMIT,
        order:"createdAt DESC"
      }
      params=$api.jsonToStr(params);
      api.ajax({
        url: 'http://d.apicloud.com/mcm/api/ware?filter='+params,
        method: 'get',
        headers: {
          "X-APICloud-AppId": "A6099267504667",
          "X-APICloud-AppKey":   appKey
        },
        
      },function(ret, err){
        if (ret) {

         activity.closeFlower({
          id:flowerid 
        });
         api.refreshHeaderLoadDone()
         updateWareList(ret);



       } 
     });
    }
    function updateWareList(_data){

      initWaterFall();
      for (var i = 0; i <_data.length; i++) {
        var html=$(" <div class='card' data-ware="+_data[i].id+" ><img src='../image/load.png' data-original="+_data[i].thumbnail+"   ><div class='description'>"+_data[i].description+"</div><div class='price'>￥"+_data[i].price+"<span class='add' data-ware2="+_data[i].id+" ><img src='../image/minicart.png' ></span></div></div>");
        $('#list').append(html);
      }
      $('.card').on('click',function(e){
        var wareid=$api.attr(this, 'data-ware');
        api.openWin({
          name: 'ware',
          url: './ware.html',
          pageParam: {
            wareId: wareid
          },
          animation:{
            type:'fade'
          }
        });

      })
      $('.add').on('click',function(e){
        e.stopPropagation();
        var wareid2=$api.attr(this, 'data-ware2');
        Add(wareid2)
      })
      $("img").lazyload({
        threshold : 200
      });
    // 优化
    api.parseTapmode();
    

    

  }
  function initWaterFall(){
   $("#list").pinterest_grid({
    no_columns: 2,
    padding_x: 10,
    padding_y: 10,
    margin_bottom: 50,
    single_column_breakpoint: 100
  });

 }
// 监听 
function initEventListenter(){
  api.addEventListener({
    name:'scrolltobottom',
    extra:{
      threshold:500
    }
  }, function(ret, err){        
   getWareList(true);
 });
}
// 下拉刷新
function initRefresh(){
  api.setCustomRefreshHeaderInfo({
    bgColor: '#C0C0C0',
    isScale: true
  }, function() {
    getWareList();

  });

}



function Add(_wareId){

 var cart=$api.getStorage('cart');
 var list=[];
 if (cart==undefined) {
  list.push(
    _wareId
    );
  $api.setStorage('cart', list);
  api.toast({
      msg: '成功添加到收藏夹',
      duration: 2000,
      location: 'bottom'
  });
}else{
  for (var i =0; i < cart.length; i++) {
    if (cart[i]==_wareId) {
      api.toast({
          msg: '此商品已存在收藏夹',
          duration: 2000,
          location: 'bottom'
      });
      return;

    }
  }
  cart.push(
    _wareId
    );
  $api.setStorage('cart', cart);
  api.toast({
      msg: '成功添加到收藏夹',
      duration: 2000,
      location: 'bottom'
  });
}

}
</script>

</html>
