<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0" />
    <meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
    <title>收货地址</title>
    <link rel="stylesheet" type="text/css" href="../css/api.css" />
    <style>    
    header {
        width: 100%;
        height: 50px;
        background-color: white;
    }
    
    header .back {
        position: absolute;
        bottom: 0;
        left: 0;
        width: 50px;
        height: 50px;
        background: url(../image/back.png);
        background-position: 12px 16px;
        background-size: 11px 18px;
        background-repeat: no-repeat;
    }
    
    header h1 {
        width: 100%;
        height: 50px;
        line-height: 50px;
        text-align: center;
        color: black;
        font-size: 16px;
    }
    
    #pay{
        width: 100%;
        height: 166px;
        margin-top: 16px;
        /*border: 1px solid red;*/
    }
    .text{
        color: gray;
        text-align: center;
        font-size: 12px;
        margin-top:25px;
    }
    #frame1>div{
        width: 100px;
        height: 30px;
        text-align: center;
        line-height: 30px;
        border-radius: 8px;
        margin-left: 12px;
        margin-top:20px; 
        color: white;
        background-color: black;
        display: inline-block;

    }

    #frame2>div{
       width: 100px;
       height: 30px;
       text-align: center;
       line-height: 30px;
       border-radius: 8px;
       margin-left: 12px;
       margin-top: 28px;
       color: white;
       background-color: black;
       display: inline-block;

   }
   .header .top {
    position: relative;
    top: 6px;
    width: 100%;
    height: 20px;
    color: #000;
    line-height: 40px;
    font-size: 14px;
    text-align: center;
}

.header .bottom {
    position: relative;
    top: 8px;
    width: 100%;
    height: 20px;
    color: #000;
    line-height: 40px;
    font-size: 24px;
    font-weight: bolder;
    text-align: center;
}


</style>
</head>

<body>
    <header id="header">
        <div class="back" tapmode onclick="api.closeFrame()"></div>
        <h1>打赏红包</h1>
    </header>
    <div class="header">
        <div class="top">潮袭余额</div>
        <div class="bottom" id="price">￥</div>
    </div>
    <nav id="nav">
        <div id="pay">
            <div id="frame1">
                <div tapmode onclick="pay(1)">1元</div>
                <div tapmode onclick="pay(2)">2元</div>
                <div tapmode onclick="pay(3)">3元</div>
            </div>
            <div id="frame2">
                <div tapmode onclick="pay(6)">6元</div>
                <div tapmode onclick="pay(8)">8元</div>
                <div tapmode onclick="pay(12)">12元</div>
            </div>
        </div>
    </nav>

</body>
<script type="text/javascript" src="../script/api.js"></script>
<script type="text/javascript" src="../script/SHA1.js"></script>
<script type="text/javascript">
  var tixianprice;
  var userid;
  var now;
  var appKey;
  var dialogBox;
  var activity;
  var myDate = new Date();
  var Y=myDate.getFullYear();
  var M=myDate.getMonth()+1;
  var D=myDate.getDate();  
  var h=myDate.getHours();    
  var m=myDate.getMinutes();
  var s=myDate.getSeconds(); 
  var date;


  apiready = function() {
    date=Y+'-'+M+'-'+D+' '+h+':'+m+':'+s;
    dialogBox = api.require('dialogBox');
    now = Date.now();    
    appKey = SHA1("A6099267504667"+"UZ"+"8FC0173C-B395-B797-D516-7A6CD23939B3"+"UZ"+now)+"."+now;
    userid=$api.getStorage('userInfo').userId;
    getusermoney();

};
function getusermoney(){

  var params={
    fields:{},
    fields: {},
    where: {
        id:userid
    },
}
params=$api.jsonToStr(params);
api.ajax({
    url: 'http://d.apicloud.com/mcm/api/user?filter='+params,
    method: 'get',
    headers: {
        "X-APICloud-AppId": "A6099267504667",
        "X-APICloud-AppKey":   appKey
    },

},function(ret, err){
    if (ret) {
       tixianprice=ret[0].money;
       var price=$api.byId('price');
       if (ret[0].money) {

          price.innerHTML='￥'+ret[0].money;
      }else{
        price.innerHTML='￥0.00';
    }

} 
});
}

function pay(money){
    if (tixianprice>money) {
       dialogBox.alert({
        texts: {
            title: '打赏',
            content: '是否打赏该玩家'+money+'元',
            leftBtnTitle: '打赏',
            rightBtnTitle: '取消'
        },
        styles: {
          bg: '#fff',
          w: 300,
          corner:2,
          title: {
            marginT: 20,
            icon: 'widget://res/gou.png',
            iconSize: 40,
            titleSize: 14,
            titleColor: '#000'
        },
        content: {
            color: '#000',
            size: 14
        },
        left: {
            marginB: 7,
            marginL: 20,
            w: 130,
            h: 35,
            corner: 2,
            bg: '#000000',
            color:'#ffffff',
            size: 12
        },
        right: {
            marginB: 7,
            marginL: 10,
            w: 130,
            h: 35,
            corner: 2,
            bg: '#000000',
            color:'#ffffff',
            size: 12
        }
    }
}, function(ret) {

    if (ret.eventType == 'left') {
        getvideouserprice(money)
        dialogBox.close({
            dialogName: 'alert'
        });


    }else{
        dialogBox.close({
            dialogName: 'alert'
        });


    }
});
   }else{
    api.toast({
        msg: '余额不足',
        duration: 2000,
        location: 'bottom'
    });
}

}


function getvideouserprice(money){
 activity = api.require('UILoading');
 activity.keyFrame({
    rect: {
        w: 80,
        h: 100
    },
    styles: {
        bg: 'rgba(0,0,0,0.5)',
        corner: 5,
        interval: 50,
        frame: {
            w: 80,
            h: 80
        }
    }
});


 var params={
    fields:{},
    fields: {},
    where: {
        id:api.pageParam.videouserid
    },

}
params=$api.jsonToStr(params);
api.ajax({
    url:  'http://d.apicloud.com/mcm/api/user?filter='+params,
    method: 'get',
    headers: {
        "X-APICloud-AppId": "A6099267504667",
        "X-APICloud-AppKey":   appKey
    },
},function(ret, err){
    if (ret) {
        if (ret[0].money==null || ret[0].money==undefined) {
         ret[0].money=0;
     }

     addvideouserprice(ret[0].money,money);
     jianmeprice(money);
       // 添加关系
       addredmoney(money);

   } 
});

}

function addvideouserprice(money,shangmoney){
   api.ajax({
    url:  'http://d.apicloud.com/mcm/api/user/'+api.pageParam.videouserid,
    method: 'put',
    headers: {
        "X-APICloud-AppId": "A6099267504667",
        "X-APICloud-AppKey":   appKey
    },
    data:{
        values:{
            money:parseInt(money)+parseInt(shangmoney)
        }
    }
},function(ret, err){
    if (ret) {

    } 
});

}

function jianmeprice(money){

   api.ajax({
    url:  'http://d.apicloud.com/mcm/api/user/'+userid,
    method: 'put',
    headers: {
        "X-APICloud-AppId": "A6099267504667",
        "X-APICloud-AppKey":   appKey
    },
    data:{
        values:{
            money:parseInt(tixianprice)-parseInt(money)
        }
    }
},function(ret, err){
    if (ret) {
       activity.closeKeyFrame();
       api.toast({
           msg: '打赏成功',
           duration: 3000,
           location: 'bottom'
       });
   } 
});

}

function addredmoney(money){
    api.ajax({
        url: 'http://d.apicloud.com/mcm/api/redmoney',
        method: 'post',
        headers: {
            "X-APICloud-AppId": "A6099267504667",
            "X-APICloud-AppKey":   appKey
        },
        data: {
            values: { 
                givemoney: userid,
                receivemoney:api.pageParam.videouserid,
                money:money,
                date:date
            },
        }
    },function(ret, err){
        if (ret) {
            getusermoney()
        }
    });

}

</script>

</html>
