<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0" />
    <meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
    <title>个人中心Frame</title>
    <link rel="stylesheet" type="text/css" href="../css/api.css" />
    <style>  
    header {
        height: 150px;
        padding-top: 8px;
        background-color: white;
    }
    
    header .icon-panel {
        width: 100%;
        height: 86px;
        text-align: center;
    }
    
    header .icon-panel .icon {
        display: inline-block;
        box-sizing: border-box;
        width: 108px;
        height: 108px;
        border: 3px solid black;
        border-radius: 108px;
        background-repeat: no-repeat;
        background-image: url(../image/default_square.png);
        background-size: 108px 108px;
        background-repeat: no-repeat;
        background-position: center center;
    }
    
    header .username {
        height: 30px;
        line-height: 30px;
        font-size: 14px;
        color: black;
        text-align: center;
        margin-top: 20px;
    }
    
    header .account-info {
        height: 30px;
        line-height: 30px;
        font-size: 12px;
        color: black;
        text-align: center;
    }
    
    .option {
        position: relative;
        box-sizing: border-box;
        width: 100%;
        height: 61px;
        border-bottom: 1px solid #ddd;
    }
    
    .option .icon {
        position: absolute;
        left: 0;
        top: 0;
        width: 40px;
        height: 60px;
        background-repeat: no-repeat;
        background-position: 12px center;
        background-size: auto 20px;
    }
    
    .option .icon-myorder {
        background-image: url(../image/dindan.png);
    }
    
    .option .icon-address {
        background-image: url(../image/dizhi.png);
    }
    .option .icon-tuijian {
        background-image: url(../image/tuijian.png);
    }
    .option .icon-vip {
        background-image: url(../image/vip.png);
    }
    
    .option .title {
        position: relative;
        box-sizing: border-box;
        width: 100%;
        height: 60px;
        padding-left: 40px;
        font-size: 14px;
        color: black;
        text-align: left;
        line-height: 60px;
    }
    
    .option .arrow-panel {
        position: absolute;
        top: 0;
        right: 12px;
        width: auto;
        height: 60px;
        background-image: url(../image/arrow_right.png);
        background-repeat: no-repeat;
        background-size: 16px 24px;
        background-position: right center;
    }
    .option .arrow-pane2 {
        position: absolute;
        top: 0;
        right: 12px;
        width: auto;
        height: 60px;
        background-image: url(../image/hongbao.png);
        background-repeat: no-repeat;
        background-size: 24px 24px;
        background-position: right center;
    }
    .option .arrow-panel .text {
        box-sizing: border-box;
        padding-right: 20px;
        width: auto;
        height: 60px;
        line-height: 60px;
        font-size: 13px;
        color: #888;
        text-align: left;
    }
    .option .arrow-pane2 .text {
        box-sizing: border-box;
        padding-right: 28px;
        width: auto;
        height: 60px;
        line-height: 60px;
        font-size: 13px;
        color: #888;
        text-align: left;
    }
    
    .highlight {
        opacity: 0.7;
    }
    .jian{
        text-align: center;
        font-size: 12px;
        margin-bottom: 6px;
        margin: 0 auto;
    }
    .vip{
        text-align: center;
        font-size: 13px;
        margin-bottom: 6px;
    }
</style>
</head>

<body>
    <header>
        <div class="icon-panel" tapmode onclick="setAvatar()">
            <div id="icon" class="icon"></div>
        </div>
        <div id="username" class="username">******</div>
        <div id="jian" class="jian">推荐人数:0</div>
        <div id="vip" class="vip"></div>
    </header>
    <section>
        <div class="option" tapmode onclick="OpentuijianWin()">
            <div class="icon icon-tuijian"></div>
            <div class="title">在家都能赚钱</div>
            <div class="arrow-pane2">
                <div class="text">躺着都能赚钱啦!</div>
            </div>
        </div>
        <div class="option" tapmode onclick="OpendindanWin()">
            <div class="icon icon-myorder"></div>
            <div class="title">我的订单</div>
            <div class="arrow-panel">
                <div class="text">查看所有订单详情</div>
            </div>
        </div>
        <div class="option" tapmode onclick="OpenAddressWin()">
            <div class="icon icon-address"></div>
            <div class="title">收货地址</div>
            <div class="arrow-panel">
                <div class="text">管理我的收货地址</div>
            </div>
        </div>
        <div class="option" tapmode onclick="OpenvipWin()">
            <div class="icon icon-vip"></div>
            <div class="title">充值vip</div>
            <div class="arrow-panel">
                <div class="text">充值18元全场8折</div>
            </div>
        </div>
    </section>
</body>
<script type="text/javascript" src="../script/api.js"></script>
<script type="text/javascript" src="../script/SHA1.js"></script>
<script type="text/javascript">
    var myDate = new Date();
    var Y=myDate.getFullYear();
    var M=myDate.getMonth()+1;
    var D=myDate.getDate();
    var now = Date.now();
    var appKey = SHA1("A6099267504667"+"UZ"+"8FC0173C-B395-B797-D516-7A6CD23939B3"+"UZ"+now)+"."+now;

    apiready = function() {
        getUsername();
        getuserInfo();
        dindantypeList();
        vip();
        event();



    };
    function event(){
        api.addEventListener({
            name: 'addvip'
        }, function(ret, err){
            if( ret ){
               vip();
           }
       });
    }
    function getuserInfo(){
        var userInfo=$api.getStorage('userInfo');
        var now = Date.now();
        var appKey = SHA1("A6099267504667"+"UZ"+"8FC0173C-B395-B797-D516-7A6CD23939B3"+"UZ"+now)+"."+now;
        api.ajax({
            url: 'https://d.apicloud.com/mcm/api/user/'+userInfo.userId,
            method: 'get',
            headers: {
                "X-APICloud-AppId": "A6099267504667",
                "X-APICloud-AppKey":   appKey,
                "Authorization":userInfo.id
            },

        },function(ret, err){
            if (ret) {
             updateLocalAvatar(ret)
         } else {
            api.toast({
                msg: err.msg,
                duration: 2000,
                location: 'bottom'
            });
        }
    });
    }   
    function vip(){
        var usernameinfo=$api.getStorage('userInfo');


        var params={
            fields: {},
            where:{
                id:usernameinfo.userId
            },
            skip: 0,
        }
        params=$api.jsonToStr(params);
        api.ajax({
            url: 'http://d.apicloud.com/mcm/api/user?filter='+params,
            method: 'get',
            headers: {
                "X-APICloud-AppId": "A6099267504667",
                "X-APICloud-AppKey":   appKey
            },

        },function(ret, err){
            if (ret) {
            // 存储用户名
            var vip=$api.byId('vip');  
            if (ret[0].vip==1) {
                vip.innerHTML='vip用户';

            }else{
                vip.innerHTML='普通用户'
            }
            date(ret[0].date);
        } else {
            api.toast({
                msg: err.msg,
                duration: 2000,
                location: 'bottom'
            });
        }
    });

    }
    function date(_date){
        var now=Y+"-"+M+"-"+D;
        var day=datedifference(_date,now);
        if (day>52){
            updatevip();

        }

    }
    function updatevip(){
     var usernameinfo=$api.getStorage('userInfo');
     api.ajax({
        url: 'http://d.apicloud.com/mcm/api/user/'+usernameinfo.userId,
        method: 'put',
        headers: {
            "X-APICloud-AppId": "A6099267504667",
            "X-APICloud-AppKey":   appKey,
            "Authorization": usernameinfo.id
        },
        data: {
            values:{
                "vip":0,
            }
        },

    },function(ret, err){
        if (ret) {
           var vip=$api.byId('vip');  
           vip.innerHTML='普通用户';
       } else {
        api.toast({
            msg: err.msg,
            duration: 2000,
            location: 'bottom'
        });
    }
});

 }
      //两个时间相差天数 兼容firefox chrome

    function datedifference(sDate1, sDate2) {    //sDate1和sDate2是2006-12-18格式  
        var dateSpan,
        tempDate,
        iDays;
        sDate1 = Date.parse(sDate1);
        sDate2 = Date.parse(sDate2);
        dateSpan = sDate2 - sDate1;
        dateSpan = Math.abs(dateSpan);
        iDays = Math.floor(dateSpan / (24 * 3600 * 1000));
        return iDays
    };

    function OpendindanWin(){
      api.openWin({
        name: 'dindan',
        url: './dindan.html',
        pageParam: {
            name: 'test'
        },
        animation: {
            type: "fade"
        }
    });
  }

  function OpenAddressWin(){
    api.openWin({
        name: 'address',
        url: './address.html',
        pageParam: {
            name: 'test'
        },
        animation: {
            type: "fade"
        }
    });
}
function OpentuijianWin(){
    api.openWin({
        name: 'tuijian',
        url: './tuijian.html',
        pageParam: {
            name: 'test'
        },
        animation: {
            type: "fade"
        }
    });
}
function OpenvipWin(){
    api.openWin({
        name: 'vip',
        url: './vip.html',
        pageParam: {
            name: 'test'
        },
        animation: {
            type: "fade"
        }
    });
}


// 在个人中心中显示头像
function setAvatar(){
   api.getPicture({
    sourceType: 'album',
    encodingType: 'jpg',
    mediaValue: 'pic',
    destinationType: 'url',
    allowEdit: true,
    quality: 50,
    // targetWidth: 100,
    // targetHeight: 100,
    saveToPhotoAlbum: false
}, function(ret, err) {
    if (ret) {
     uploadAtavar(ret.data)
 }

});

}
// 上传头像 
function uploadAtavar(_data){

  var now = Date.now();
  var appKey = SHA1("A6099267504667"+"UZ"+"8FC0173C-B395-B797-D516-7A6CD23939B3"+"UZ"+now)+"."+now;
  api.ajax({
    url: 'https://d.apicloud.com/mcm/api/file',
    method: 'post',
    data: {
        values: { 
            filename: 'icon'
        },
        files: { 
            file: _data
        }
    },
    headers: {
        "X-APICloud-AppId": "A6099267504667",
        "X-APICloud-AppKey":   appKey
    },
},function(ret, err){
    if (ret) {

        updateUserAtavar(ret)
    } else {
        api.toast({
            msg: err.msg,
            duration: 2000,
            location: 'bottom'
        });
    }
});
}
// 更改头像
function updateUserAtavar(_data){
    // alert($api.jsonToStr(_data))
    var now = Date.now();
    var appKey = SHA1("A6099267504667"+"UZ"+"8FC0173C-B395-B797-D516-7A6CD23939B3"+"UZ"+now)+"."+now;
    var userInfo=$api.getStorage('userInfo');
    api.ajax({
        url: 'https://d.apicloud.com/mcm/api/user/'+userInfo.userId,
        method: 'put',
        headers: {
            "X-APICloud-AppId": "A6099267504667",
            "X-APICloud-AppKey":   appKey,
            "Authorization":userInfo.id
        },
        data: {
            values: { 
                avatar: _data
            }

        }
    },function(ret, err){
        if (ret) {
         updateLocalAvatar(ret)
     } else {
        api.toast({
            msg: err.msg,
            duration: 2000,
            location: 'bottom'
        });
    }
});
}   
// 改变头像路径
function updateLocalAvatar(_data){
    var icon=$api.byId('icon');
    if (!_data.avatar) {
        return;
    }
    api.imageCache({
        url: _data.avatar.url
    }, function(ret, err){
        if( ret ){
         icon.style.background='url('+ret.url+')';
         icon.style.backgroundSize='108px 108px';
     }else{
        api.toast({
            msg: err.msg,
            duration: 2000,
            location: 'bottom'
        });

    }
});

}
// 在个人中心中显示用户名
function getUsername(){
    var username=$api.byId('username');
    var jian=$api.byId('jian');
    var usernameinfo=$api.getStorage('userInfo');

    var now = Date.now();
    var appKey = SHA1("A6099267504667"+"UZ"+"8FC0173C-B395-B797-D516-7A6CD23939B3"+"UZ"+now)+"."+now;
    var params={
        fields: {},
        where:{
            id:usernameinfo.userId
        },
        skip: 0,
    }
    params=$api.jsonToStr(params);
    api.ajax({
        url: 'http://d.apicloud.com/mcm/api/user?filter='+params,
        method: 'get',
        headers: {
            "X-APICloud-AppId": "A6099267504667",
            "X-APICloud-AppKey":   appKey
        },

    },function(ret, err){
        if (ret) {
            // 存储用户名
            $api.setStorage('user', ret);
            username.innerHTML=ret[0].username;
            if (ret[0].count==undefined) {
                jian.innerHTML='推荐人数:0'
            }else{
                jian.innerHTML='推荐人数:'+ret[0].count;
            }
        } else {
            api.toast({
                msg: err.msg,
                duration: 2000,
                location: 'bottom'
            });
        }
    });

}   
function dindantypeList(){
  var dindantypeList=$api.getStorage('dindantypeList');
  if (!dindantypeList) {
   dindantypeList=[
   {
    "id": "5c2a39add37a824c5ac6cc64",
    "name": "已签收"
},

{
    "id": "5c2a3991af3114d73d9ddfc2",
    "name": "待付款",
} ,
{
    "id": "5c2a39a2af3114d73d9ddfc3",
    "name": "待收货"
}
];
}
getdindantypeList();
}
function getdindantypeList(){
 var now = Date.now();
      //5FB51794-FCDC-1FE9-19E0-xxxxxxxxxxxx换成自己appkey
      var appKey = SHA1("A6099267504667"+"UZ"+"8FC0173C-B395-B797-D516-7A6CD23939B3"+"UZ"+now)+"."+now

      var params={
        fields:{},
        where:{},
        skip:0,
        limit:3
    }
    params=$api.jsonToStr(params);
    api.ajax({
        url: 'http://d.apicloud.com/mcm/api/dindantype?filter='+params,
        method: 'get',
        headers: {
          "X-APICloud-AppId": "A6099267504667",
          "X-APICloud-AppKey":   appKey
      },

  },function(ret, err){
     $api.setStorage('dindantypeList', ret);
 });
}
</script>

</html>
