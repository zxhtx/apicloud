<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0" />
  <title>title</title>
  <link rel="stylesheet" type="text/css" href="../css/api.css" />
  <style>
  html ,body{
    background-color: transparent;
    /*border: 1px solid red;*/
  }
  #list>.img{
    /*border:1px solid red;*/
  }
/*#list>#icon{
  margin-bottom:20px;
  border-radius: 50%;
  border-color: black; 
  }  */
  
</style>
</head>

<body>
  <div id="list">
    <img class="img" id="zan" tapmode onclick="xiangji()" src="../image/photo.png" alt="" width="28px" height="28px"> 
  </div>

</body>
<script type="text/javascript" src="../script/api.js"></script>
<script type="text/javascript">
 var dialogBox;
 var recordVideo;
 var texts;
 var videourl;
 var videoid;
 apiready = function() {
  dialogBox = api.require('dialogBox');
  recordVideo = api.require('weChatVideo');
  



};

function xiangji(){
  api.execScript({
        // name: 'winName',
        frameName: 'caoshi_frame',
        script: 'videopuase();'
      });
  var userInfo=$api.getStorage('userInfo');
  if (userInfo==undefined && userInfo==null) {
   api.openWin({
    name: 'login',
    url: './login.html',
    animation: {
      type: "fade"
    }
  });
   return;
 }

 dialogBox.alert({
  texts: {
    title: '摄像',
    content: '选择摄像',
    leftBtnTitle: '相机',
    rightBtnTitle: '视频库'
  },
  styles: {
    bg: '#fff',
    w: 300,
    corner:2,
    title: {
      marginT: 20,
      icon: 'widget://res/gou.png',
      iconSize: 40,
      titleSize: 14,
      titleColor: '#000'
    },
    content: {
      color: '#000',
      size: 14
    },
    left: {
      marginB: 7,
      marginL: 20,
      w: 130,
      h: 35,
      corner: 2,
      bg: '#000000',
      color:'#ffffff',
      size: 12
    },
    right: {
      marginB: 7,
      marginL: 10,
      w: 130,
      h: 35,
      corner: 2,
      bg: '#000000',
      color:'#ffffff',
      size: 12
    }
  }
}, function(ret) {
  if (ret.eventType == 'left') {
    shexiang();

  }else{
    videoku();
  }
});


}

function shexiang(){
  var recordVideo = api.require('weChatVideo');
  recordVideo.open({
    maxTime: 58
  }, function(data){
    if (data.status==true) {
     videourl=data.videourl;
     input();
   }
 })

  dialogBox.close({
    dialogName: 'alert'
  });

}

function videoku(){
  api.getPicture({
    sourceType: 'library',
    encodingType: 'jpg',
    mediaValue: 'video',
    destinationType: 'url',
    allowEdit: true,
    quality: 50,
    // targetWidth: 100,
    // targetHeight: 100,
    saveToPhotoAlbum: false
  }, function(ret, err) {
    if (ret) {
      if (ret.data!='') {
        videourl=ret.data;
        input();
      }
    } 
  });

}
function input(){
  dialogBox.input({
    keyboardType: 'default',
    texts: {
      title: '发布视频',
      placeholder: '说两句吧!',
      leftBtnTitle: '取消',
      rightBtnTitle: '确定'
    },
    styles: {
      bg: '#fff',
      corner: 2,
      w: 300,
      h: 240,
      title: {
        h: 60,
        alignment: 'center',
        size: 14,
        color: '#000',
        marginT:30,
      },
      input: {
        h: 60,
        y:30,
        marginT:15,
        marginLeft: 10,
        marginRight:10,
        textSize: 14,
        textColor: '#000'
      },
      dividingLine: {
        width: 0.5,
        color: '#696969'
      },
      left: {
        bg: 'rgba(0,0,0,0)',
        color: '#007FFF',
        size: 12
      },
      right: {
        bg: 'rgba(0,0,0,0)',
        color: '#007FFF',
        size: 12
      }
    }
  }, function(ret) {

    if (ret.eventType == 'left') {
      api.toast({
        msg: '取消视频上传',
        duration: 2000,
        location: 'bottom'
      });
      dialogBox.close({
        dialogName: 'input'
      });
    }else{
      if (ret.text=='') {
        texts='话太多...视频表达'
      }else{
        texts=ret.text;
      }

      addtext(texts);

      dialogBox.close({
        dialogName: 'input'
      });


    }
  });

}

function addtext(texts){
  var userInfo=$api.getStorage('user');
  var addinfo={
    title:texts,
    userid:userInfo[0].id,
    username:userInfo[0].username

  }
  var now = Date.now();
      //5FB51794-FCDC-1FE9-19E0-xxxxxxxxxxxx换成自己appkey
      var appKey = SHA1("A6099267504667"+"UZ"+"8FC0173C-B395-B797-D516-7A6CD23939B3"+"UZ"+now)+"."+now;
      var userInfo=$api.getStorage('userInfo');
      api.ajax({
        url: 'https://d.apicloud.com/mcm/api/video1',
        method: 'post',
        headers: {
         "X-APICloud-AppId": "A6099267504667",
         "X-APICloud-AppKey":   appKey,
         "Authorization": userInfo.id
       },
       data: {
        values: addinfo
      }
    }, function(ret, err) {
      videoid=ret.id;
      addvideourl(videourl);
    });
    }

    function addvideourl(videourl){
      var now = Date.now();
      var appKey = SHA1("A6099267504667"+"UZ"+"8FC0173C-B395-B797-D516-7A6CD23939B3"+"UZ"+now)+"."+now;
      api.ajax({
        url: 'https://d.apicloud.com/mcm/api/file',
        method: 'post',
        data: {
          values: { 
            filename: 'video'
          },
          files: { 
            file: videourl
          }
        },
        headers: {
          "X-APICloud-AppId": "A6099267504667",
          "X-APICloud-AppKey":   appKey
        },
      },function(ret, err){
        if (ret) {

          updatevideourl(ret)
        } else {
          api.toast({
            msg: err.msg,
            duration: 2000,
            location: 'bottom'
          });
        }
      });

    }

    function updatevideourl(videourlH){
     var now = Date.now();
     var appKey = SHA1("A6099267504667"+"UZ"+"8FC0173C-B395-B797-D516-7A6CD23939B3"+"UZ"+now)+"."+now;
     var userInfo=$api.getStorage('userInfo');
     api.ajax({
      url: 'https://d.apicloud.com/mcm/api/video1/'+videoid,
      method: 'put',
      headers: {
        "X-APICloud-AppId": "A6099267504667",
        "X-APICloud-AppKey":   appKey,
        "Authorization":userInfo.id
      },
      data: {
        values: { 
          video: videourlH
        }

      }
    },function(ret, err){
      if (ret) {
        api.toast({
          msg: '视频上传成功',
          duration: 2000,
          location: 'bottom'
        });
      } else {
        api.toast({
          msg: err.msg,
          duration: 2000,
          location: 'bottom'
        });
      }
    });
   }


 </script>

 </html>
