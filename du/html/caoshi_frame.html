<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0" />
    <title>title</title>
    <link rel="stylesheet" type="text/css" href="../css/api.css" />
    <style>
    html,
    body {
        background-color: transparent;
    }

    #container {
        padding: 11px;  
        /*padding-bottom:11px;       */
    }

    #container>.card {
        margin-bottom: 39px;        
        position: relative;
        float: left;
        padding: 4px;
        border-radius: 8%;
        box-sizing: border-box;
        background-clip: content-box;
        background-position: center;
        background-repeat: no-repeat;
        background-size: cover;
    }

    #container>.card>.favorite {
        position: absolute;
        width: 14px;
        height: 13px;
        left: 15.5px;
        top: 17px;
        background-position: center;
        background-repeat: no-repeat;
        background-size: contain;
        background-image: url(../image/favorite-list.png);
    }

    #container>.card>.room-name {
        position: absolute;
        left: 14px;
        bottom: 13px;
        height: 16.5px;
        line-height: 16.5px;
        font-size: 16.5px;
        color: white;
    }

    #container>.card>.gender {
        position: absolute;
        bottom: 15px;
        right: 30.5px;
        width: 13px;
        height: 13px;
        background-position: center;
        background-repeat: no-repeat;
        background-size: contain;
        background-image: url(../image/male.png);
    }

    #container>.card>.age {
        position: absolute;
        right: 11px;
        bottom: 13px;
        font-size: 14px;
        line-height: 14px;
        color: white;
    }
    .card>img{
        display:none;
    }


    .card>p{
        position: absolute;
        bottom: -30px;  
        font-size: 16px;
    }
</style>
</head>

<body>
    <div id="container">

    </div>
    <!-- <div class="push-status" id="pushStatus">上拉显示更多</div> -->
</body>
<script type="text/template" id="template">
   {{~ it.list:v:i}}
   <div class="card" style="width:{{= (it.frameWidth - 22) / 2}}px;height:{{=(it.frameWidth - 22) / 2 * 1.3416}}px;" data-imageurl="{{=v.image.url}}" onclick="fnOpenRoom('{{=v.video.url}}','{{=v.title}}')" tapmode>
    <img src="../image/all.png" onload="fnLoadCardImage(this,'{{=v.id}}','{{=v.title}}')">
    <p id="zishu_{{=v.id}}"  tapmode onclick="opensearch('{{=v.title}}')">{{=v.title}}</p> 
</div>

{{~}}
</script>
<script type="text/javascript" src="../script/api.js"></script>
<script type="text/javascript" src="../script/SHA1.js"></script>
<script type="text/javascript" src="../script/doT.min.js"></script>
<script type="text/javascript">
    var skip = 0;
    var LIMIT = 8;

    var city = null;
    var favorite = false;
    apiready = function() {
        fnLoadList();
        fnPullRefresh();
        initEventListenter();
        window.setInterval(tishi,20000);
        keybackeventer();
        // alert(api.pageParam.Winh)
        // alert(api.frameHeight)

        
    };
    function keybackeventer(){
        api.addEventListener({
                name: 'keyback'
            }, function(ret, err){
                api.toast({
                    msg: '双击退出视频',
                    duration:2000,
                    location: 'bottom'
                });

                api.addEventListener({
                    name: 'keyback'
                }, function(ret, err){
                   api.closeFrame();
                });

                setTimeout(function(){
                    keybackeventer();
                },3000)
            });

    }


    function tishi(){
        api.toast({
            msg: '点击视频下方关键字即可搜索',
            duration: 3000,
            location: 'bottom'
        });
    }
    function fnLoadCardImage(element,videoid,videotitle){

        // alert(videotitle)
        var text=videotitle,
        text=text.substr(0,9)+'...';
        // alert(text)
        var zishu=$api.byId('zishu_'+videoid);
        zishu.innerHTML=text;
        var eCard = $api.closest(element, '.card');
        var imageurl = eCard.dataset['imageurl'];
        api.imageCache({
            url: imageurl
        }, function(ret, err){
            eCard.style.backgroundImage = "url(" + ret.url + ")";
        });
    }
    function opensearch(title) {

        event.stopPropagation();
        api.openWin({
            name: 'search.html',
            url: './search.html',
            pageParam: {
                searchtitle: title
            }
        });
        

    };
    function fnOpenRoom(element,element2){
        api.openWin({
            name: 'video',
            url: './video.html',
            pageParam: {
                videourl: element,
                videotitle:element2
            }
        });
//      var moviePlayer = api.require('moviePlayer');
//      moviePlayer.open({
//       rect: {
//         x: 0,
//         y: 0,
//         w: api.frameWidth,
//         h: api.frameHeight+50
//     },
//     texts:{
//         title:element2
//     },
//     styles: {
//         head: {
//           bg: '#000000',
//           height: 44,
//           y: 20,

//           title: {
//             size: 20,
//             color: '#0f0',
//             width: 40,
//             leftMargin: 20
//         },
//         backSize: 20,
//         backImg: 'widget://image/back.png',
//         customButtons: [{
//             w: 20,
//             h: 20,
//             rightMagin: 10,
//             img: 'widget://image/more.png',
//             imgSelected: 'fs://image/collectSelected.png',

//         }]
//     },
//     foot: {
//       bg: '#000000',
//       height: 44,
//       palyBtn: {
//         size: 20,
//         playImg: 'widget://image/play.png',
//         pauseImg: 'widget://image/pause.png',
//         marginLeft: 5
//     },
//     currentTimeLabel: {
//         textSize: 12,
//         textColor: "#FFF",
//         textWidth: 43,
//         marginLeft: 5
//     },
//     seekBar: {
//         sliderImg: 'widget://image/slder.png',
//         sliderW: 15,
//         sliderH: 8,
//         progressColor: '#FEFEFF',
//         progressSelected: '#C1C1C1',
//         marginLeft: 10,
//         marginRight: 10
//     },
//     totalTimeLabel: {
//         textSize: 12,
//         textColor: "#FFF",
//         textWidth: 43,
//         marginRight: 5
//     },
//     fullscreenBtn: {
//         size: 20,
//         verticalImg: 'widget://image/fullscreen.png',
//         horizontalImg: 'widget://image/unfullscreen.png',
//     }
// }
// },
//             // path: 'http://haokan.baidu.com/v?pd=wisenatural&vid=6569257479234811442',

//             path: element,
//             // videoDirection:portrait,
//             showBack:false,
//             autorotation:false,
//             isShowStatusBar:false,
//             autoPlay: true,
//             // coverlmg:'widget://yue.png'
//         }, function(ret, err) {
//             if (ret) {
//                 // alert(JSON.stringify(ret));
//                 // } else {
//                 // alert(JSON.stringify(err));
//             }

//         });


 };




 function fnPullRefresh(){
    api.setCustomRefreshHeaderInfo({
        bgColor: '#C0C0C0',
        isScale: true
    }, function() {
        fnLoadList();

    });

}

function fnLoadList(_LoadMore) {
  if (_LoadMore) {
    skip+=LIMIT;
}else{

    skip=0;
}
var params={
    fields:{},
    fields: {},
    skip:skip,
    limit:LIMIT
}
params=$api.jsonToStr(params);

var now = Date.now();
      //5FB51794-FCDC-1FE9-19E0-xxxxxxxxxxxx换成自己appkey
      var appKey = SHA1("A6099267504667"+"UZ"+"8FC0173C-B395-B797-D516-7A6CD23939B3"+"UZ"+now)+"."+now;
      api.ajax({
        url: 'https://d.apicloud.com/mcm/api/video1?filter='+params,
        headers: {
            'X-APICloud-AppId': 'A6099267504667',
            'X-APICloud-AppKey': appKey
        },
        method: 'get'
    }, function(ret, err) {
        // alert($api.jsonToStr(ret))
        fnRenderList(ret,_LoadMore);
        // alert(ret.length)
    });
  }

  function fnRenderList(ret,_LoadMore) {


    var param = {
        list: ret,
        frameWidth: api.frameWidth,
        frameHeight: api.frameHeight
    };
    var list=$api.byId('container');
    var tempFn=doT.template($api.byId('template').innerHTML);
    var resultText=tempFn(param);
    if (_LoadMore) {
        $api.append(list, resultText);
    }else{
        $api.html(list, resultText);
    }
    // 优化
    api.parseTapmode();

    api.refreshHeaderLoadDone();
}
function initEventListenter(){
    api.addEventListener({
        name:'scrolltobottom',
        extra:{
            threshold:100
        }
    }, function(ret, err){        
     fnLoadList(true);
 });
}
</script>

</html>
