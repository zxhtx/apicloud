<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0" />
  <title>title</title>
  <link rel="stylesheet" type="text/css" href="../css/api.css" />
  <style>
  html ,body{
    background-color: transparent;
    /*border: 1px solid red;*/
  }
  #list>.img{
    margin: 8px 0px 0px 10px;
  }
/*#list>#icon{
  margin-bottom:20px;
  border-radius: 50%;
  border-color: black; 
  }  */
  
  .zancount{
    width: 49px;
    height: 20px;
    /*border: 1px solid red;*/
    text-align: center;
    margin-left: 2px;
    color: white;
  }
  #zan{
    margin: 8px 0px 0px 8px;
  }

  .count{
    width: 49px;
    height: 20px;
    /*border: 1px solid red;*/
    text-align: center;
    /*margin-left: 3px;*/
    color: white;
  }
</style>
</head>

<body>
  <div id="list">

    <img  id="zan" tapmode onclick="zanandzan2()" src="../image/zan.png" alt="" width="35px" height="30px">
    <div class="zancount" id="likecount">0</div>
    <img class="img" src="../image/say.png" alt="" width="30px" height="30px"> 
    <div class="count" >0</div>
    <img class="img" src="../image/xiazai.png"  tapmode onclick="xiazai()" alt="" width="30px" height="30px">
    <div class="count" id="downcount">0</div> 
    <img class="img" src="../image/redbao.png" alt="" width="26px" height="30px">
    <div class="count">￥0</div> 
  </div>

</body>
<script type="text/javascript" src="../script/api.js"></script>
<script type="text/javascript" src="../script/SHA1.js"></script>
<script type="text/javascript">
  var redzan=0;
  var videourl;
  var count1;
  var likeelent;
  var videoid;
  var now;
  var appKey;
  var deletevideo;
  apiready = function() {
   now = Date.now();
   appKey = SHA1("A6099267504667"+"UZ"+"8FC0173C-B395-B797-D516-7A6CD23939B3"+"UZ"+now)+"."+now;
   count1=0;
   likeelent=0;
   // event();
   getuser();


 };



 function zanandzan2(){
  var likecount=$api.byId('likecount');
  if (redzan==0) {
    var zan=$api.byId('zan');
    zan.src='../image/zan2.png';
    var one=1;
    likecount.innerHTML=parseInt(likecount.innerHTML)+one;
    // alert(likecount.innerHTML)
    redzan=1;
    addlike();
    addlikeuser();


  }else{


   // redzan=0;
   return;



 }

}

 // 点赞+1
 function addlike(){
   var userInfo = $api.getStorage('userInfo');
   var likecount=$api.byId('likecount');
   api.ajax({
    url: 'https://d.apicloud.com/mcm/api/video1/'+videoid,
    method: 'put',
    data: {
      values:{
        "like":parseInt(likecount.innerHTML),
      }
    },
    headers: {
     "X-APICloud-AppId": "A6099267504667",
     "X-APICloud-AppKey":   appKey,
     "Authorization": userInfo.id
   }
 },function(ret, err){
  if (ret) {
    // alert($api.jsonToStr(ret))
    

  }
});
 }

// 点赞 添加关系
function addlikeuser(){
 var userInfo=$api.getStorage('user');
 api.ajax({
  url: 'https://d.apicloud.com/mcm/api/likevideo',
  method: 'post',
  data: {
    values: { 
      likeuserid:userInfo[0].id,
      belikeuserid:videoid
    }
  },
  headers: {
    "X-APICloud-AppId": "A6099267504667",
    "X-APICloud-AppKey":   appKey,
  },
},function(ret, err){

});
}


function getlikevideo(id){
 var userInfo=$api.getStorage('user');

 var params={
  fields: {},
  where:{
    likeuserid:userInfo[0].id,
    belikeuserid:id
  },
}
params=$api.jsonToStr(params);
api.ajax({
  url: 'http://d.apicloud.com/mcm/api/likevideo?filter='+params,
  method: 'get',
  headers: {
    "X-APICloud-AppId": "A6099267504667",
    "X-APICloud-AppKey":   appKey
  },

},function(ret, err){
  if (ret) {
    var zan=$api.byId('zan');
    if (ret.length!=0) {
      for (var i =0 ; i<ret.length; i++) {
        if (ret[i].belikeuserid==id) {
          zan.src='../image/zan2.png'
          redzan=1;

          break;
        }else{
          zan.src='../image/zan.png'
          // redzan=0;
        }
      }   
    }else{
      zan.src='../image/zan.png'
      // redzan=0;
    }
  }
});


}

function getlikecount(vid){
  var likecount=$api.byId('likecount');
  var params={
    fields: {},
    where:{
      id:vid,
    },
    skip: 0,
  // include: ['belikeuseridPointer']
}
params=$api.jsonToStr(params);
api.ajax({
  url: 'http://d.apicloud.com/mcm/api/video1?filter='+params,
  method: 'get',
  headers: {
    "X-APICloud-AppId": "A6099267504667",
    "X-APICloud-AppKey":   appKey
  },

},function(ret, err){
  if (ret) {

   likecount.innerHTML=ret[0].like;
   likeelent=ret[0].like;
 }
})

}

function getuser(ret){


  api.addEventListener({
    name: 'userandtext'
  }, function(ret, err){
    if( ret ){
      var likecount=$api.byId('likecount');
      var downcount=$api.byId('downcount');
      downcount.innerHTML=ret.value.key1.down;
      likecount.innerHTML=ret.value.key1.like;
      videoid=ret.value.key1.id;
      videourl=ret.value.key1.video;
      getlikevideo(videoid);
      // getlikecount(videoid);
      redzan=0
      

      

    }
  });
}




function xiazai(){
  var downcount=$api.byId('downcount');
  downcount.innerHTML=parseInt(downcount.innerHTML)+1;
  api.toast({
    msg: '正在下载',
    duration: 2000,
    location: 'bottom'
  });
  var myDate=new Date;
  var h=myDate.getTime(); 
  var fs='fs://'+h+'.mp4';
  api.download({
    url: videourl,
    savePath: fs,
    report: true,
    cache: false,
    allowResume: false,
  }, function(ret, err) {
    if (ret.state == 1) {
  
      api.saveMediaToAlbum({
        path: ret.savePath
      }, function(ret, err) {
        if (ret && ret.status) {
          
          api.toast({
            msg: '下载成功',
            duration: 2000,
            location: 'bottom'
          });
          adddown();
        } 
      });
    } 
  });




}
function adddown(){
  var downcount=$api.byId('downcount');
  api.ajax({
    url: 'https://d.apicloud.com/mcm/api/video1/'+videoid,
    method: 'put',
    data: {
      values:{
        "down":parseInt(downcount.innerHTML),
      }
    },
    headers: {
     "X-APICloud-AppId": "A6099267504667",
     "X-APICloud-AppKey":   appKey,
   }
 },function(ret, err){
  if (ret) {
   
  }
});

}
</script>

</html>
