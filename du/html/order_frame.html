<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0" />
    <meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
    <title>下单Frame</title>
    <link rel="stylesheet" type="text/css" href="../css/api.css" />
    <!-- <link rel="stylesheet" type="text/css" href="../script/mui/css/mui.min.css" /> -->
    <style>
    html,
    body {
        height: 100%;
        background-color: #f0f0f0;
    }
    
    .address {
        position: relative;
        box-sizing: border-box;
        width: 100%;
        height: auto;
        margin-bottom: 8px;
        padding: 8px 16px;
        background-color: #fff;
    }
    
    .address .icon {
        position: absolute;
        top: 21px;
        left: 16px;
        width: 19px;
        height: 24px;
        background-image: url(../image/icon_address.png);
        background-repeat: no-repeat;
        background-size: auto 20px;
        background-position: center center;

    }
    
    .address .sign {
        display: none;
        position: absolute;
        top: 45px;
        left: 8px;
        width: 35px;
        height: 14px;
        line-height: 14px;
        font-size: 12px;
        color: #444;
        text-align: center;
    }
    
    .address .sign-1 {
        display: block;
    }
    
    .address .info {
        position: relative;
        box-sizing: border-box;
        padding-left: 36px;
        padding-right: 28px;
        width: 100%;
        height: auto;
    }
    
    .address .info .top {
        position: relative;
        box-sizing: border-box;
        width: 100%;
        height: 32px;
        color: #444;
        line-height: 32px;
        font-size: 14px;
    }
    
    .address .info .top .consignee {
        display: inline;
        width: auto;
    }
    
    .address .info .top .mobile {
        display: inline;
        width: auto;
        margin-left: 16px;
    }
    
    .address .info .bottom {
        position: relative;
        width: 100%;
        min-height: 32px;
        line-height: 32px;
        color: #888;
        font-size: 14px;
    }
    
    .address .info .bottom .type {
        display: inline;
        width: auto;
        color: black;
        font-weight: bolder;
    }
    
    .address .info .bottom .text {
        display: inline;
        width: auto;
    }
    
    .address .arrow {
        position: absolute;
        right: 16px;
        top: 32px;
        width: 8px;
        height: 16px;
        background-image: url(../image/item_user_address_right.png);
        background-repeat: no-repeat;
        background-size: 8px 16px;
        background-position: right center;
    }
    
    .order {
        position: relative;
        width: 100%;
        height: auto;
        margin-bottom: 50px;
    }
    
    .order .title {
        position: relative;
        box-sizing: border-box;
        padding-left: 40px;
        width: 100%;
        height: 44px;
        line-height: 44px;
        font-size: 16px;
        text-align: left;
        color: #444;
        background-color: #fff;
        background-image: url(../image/dindan.png);
        background-repeat: no-repeat;
        background-size: auto 20px;
        background-position: 16px center;
    }
    
    .order .icon-panel {
        position: relative;
        display: -webkit-box;
        display: -webkit-flex;
        display: flex;
        -webkit-box-orient: horizontal;
        -webkit-flex-flow: row;
        flex-flow: row;
        box-sizing: border-box;
        padding: 8px 16px;
        width: 100%;
        height: 80px;
        background-color: #f1f5f8;
    }
    
    .order .icon-panel .icon {
        width: 64px;
        height: 64px;
        border-radius: 8px;
    }
    .order .icon-panel .icon img{
        width: 64px;
        height: 100%;
        border-radius: 10px;
    }
    
    .order .icon-panel .info {
        position: relative;
        -webkit-box-flex: 1;
        -webkit-flex: 1;
        flex: 1;
        box-sizing: border-box;
        padding-left: 16px;
    }
    
    .order .icon-panel .info .top {
        position: relative;
        box-sizing: border-box;
        padding-top: 8px;
        width: 100%;
        height: 32px;
        font-size: 16px;
        color: #444;
        text-align: left;
    }
    
    .order .icon-panel .info .bottom {
        position: relative;
        box-sizing: border-box;
        padding-bottom:2px;
        width: 100%;
        height: 32px;
        font-size: 16px;
        color: #444;
        text-align: left;
    }
    
    .order .icon-panel .right {
        box-sizing: border-box;
        width: 40px;
        height: 64px;
        padding-top: 50px;
        font-size: 14px;
        text-align: right;
    }
    
    .order .row {
        position: relative;
        box-sizing: border-box;
        padding-left: 16px;
        padding-right: 16px;
        width: 100%;
        height: 44px;
        line-height: 44px;
        font-size: 16px;
        margin-bottom: 1px;
        background-color: #fff;
    }
    
    .order .row .text {
        position: relative;
        width: 100%;
        height: 44px;
        text-align: left;
        color: #444;
    }
    
    .order .row .value {
        position: absolute;
        box-sizing: border-box;
        top: 0;
        right: 16px;
        width: 100%;
        height: 44px;
        text-align: right;
        color: #444;
    }
    
    .order .row .value-1 {
        padding-right: 20px;
        background-image: url(../image/arrow_right.png);
        background-repeat: no-repeat;
        background-size: 12px 20px;
        background-position: right center;
        color: black;
    }
    
    .order .row .value-2 {
        color: black;
    }
    
    .order .row-1 {
        position: relative;
        box-sizing: border-box;
        padding-left: 16px;
        padding-right: 16px;
        width: 100%;
        height: 44px;
        line-height: 44px;
        text-align: right;
        font-size: 16px;
        background-color: #fff;
    }
    
    .color {
        color: black;
    }
    
    .pay {
        position: relative;
        width: 100%;
        height: auto;
    }
    
    .pay .title {
        position: relative;
        box-sizing: border-box;
        padding-left: 40px;
        width: 100%;
        height: 44px;
        line-height: 44px;
        font-size: 16px;
        text-align: left;
        color: black;
        background-color: #fff;
        background-image: url(../image/order_pay.png);
        background-repeat: no-repeat;
        background-size: auto 16px;
        background-position: 12px center;
    }
    
    .pay .row {
        position: relative;
        box-sizing: border-box;
        width: 100%;
        height: 50px;
        margin-bottom: 1px;
        padding-left: 96px;
        text-align: left;
        font-size: 16px;
        color: black;
        line-height: 50px;
        background-color: #fff;
        background-repeat: no-repeat;
        background-size: auto 36px;
        background-position: 12px center;
    }
    
    .pay .row-balance-pay {
        background-image: url(../image/icon_balance_pay.png);
    }
    
    .pay .row-wxpay {
        background-image: url(../image/icon_wxpay.png);
    }
    
    .pay .row-alipay {
        background-image: url(../image/icon_alipay.png);
    }
    
    .pay .row-disable {
        opacity: 0.5;
    }
    
    .pay .row .text {
        display: inline-block;
        width: auto;
        height: 50px;
    }
    
    .pay .row .text-recommend {
        box-sizing: border-box;
        padding-right: 28px;
        display: inline-block;
        width: auto;
        height: 50px;
        background-image: url(../image/recommend.png);
        background-repeat: no-repeat;
        background-size: 20px 20px;
        background-position: right center;
        border-radius: 10px;
    }
    
    .pay .row .select {
        position: absolute;
        top: 0;
        right: 16px;
        width: 50px;
        height: 50px;
        background-repeat: no-repeat;
        background-position: right center;
        background-size: auto 20px;
        background-image: url(../image/order_off.png);
    }
    
    .pay .row .selected {
        background-image: url(../image/order_on.png);
    }
    
    .highlight {
        opacity: 0.7;
    }
    .info .description {
        /*margin-bottom: 3px;*/
        overflow: hidden;
        width: 100%;
        height: 16px;
        font-size: 13px;
        color: #9d9d9d;
    }
    #footer{
      display: -webkit-box;
      display: -webkit-flex;
      display: flex;
      -webkit-box-orient: horizontal;
      -webkit-flex-flow: row;
      flex-flow: row;
      width: 100%;
      height: 50px;
      background-color: #fff;
      position: fixed;
      left: 0px;
      bottom: 0px;

  }

  #footer .panel {
    -webkit-box-flex: 1;
    -webkit-flex: 1;
    flex: 1;
    height: 50px;
    box-sizing: border-box;
    padding-left: 16px;
    line-height: 50px;
    color: #000;
    font-size: 18px;
    text-align: left;
}

#footer .buy {
    width: 47px;
    height: 47px;
}

#footer .buy .buy-button {
    width: 47px;
    height: 47px;
    position: absolute;
    right: 0;
    margin-right: 18px;
}
</style>
</head>

<body>
    <section class="address" id="address">
        <div class="icon">
        </div>
        <div class="info">
            <div class="top">
                <div class="consignee" id="shouhuoren">收货人：...</div>
                <div class="mobile" id="mobile">...</div>
            </div>
            <div class="bottom">
                <div class="type" id="type">【...】</div>
                <div class="text" id="text">...</div>
            </div>
        </div>
    </section>
    <section class="order">
        <div class="title">订单信息</div>
        <div class="icon-panel">
            <div class="icon" id="icon">
                <img src="../image/order_ware.gif" id="image" alt="">
            </div>
            <div class="info">
                <div class="top" id="warename">佳沛绿奇异果</div>
                <div class="description" id="description"></div>
                <div class="bottom" id="wareprice">￥19.9</div>
            </div>
        </div>
        <div class="row">
            <div class="text">商品金额:</div>
            <div class="value value-2" id="price1">+&nbsp;￥19.9</div>
        </div>
        <div class="row">
            <div class="text">运费：</div>
            <div class="value value-2">&nbsp;运费平台付</div>
        </div>
        <div class="row">
            <div class="text">VIP优惠：</div>
            <div class="value value-2" id="viptext">-&nbsp;￥0.0</div>
        </div>
        <div class="row">
            <div class="text">返现金(商品中扣除):</div>
            <div class="value value-2" id="fanqian">&nbsp;￥0.0</div>
        </div>
        <div class="row-1">
            <div class="value value-2">实付款：&nbsp;<span class="color" id="price2">￥24.9</span></div>
        </div>
    </section>
    <footer id="footer">
        <div class="panel" id="price3">总金额:￥24.9</div>
        <div class="buy">
            <img class="buy-button" src="../image/confirm.png" tapmode onclick="yesadd()">
        </div>
    </footer>
</body>
<script type="text/javascript" src="../script/api.js"></script>
<script type="text/javascript" src="../script/SHA1.js"></script>
<!-- <script type="text/javascript" src="../script/mui/js/mui.min.js"></script> -->
<script type="text/javascript">
    var price3;
    var dizhinull;
    var activity;
    var flowerid1;
     var flowerid2;
     var flowerid3;
    apiready = function() {
        getware();
        getaddress();
        var jiage;


    };
    var addInfo = {
        dindantypeid:'5c2a3991af3114d73d9ddfc2',
    };
    var types = ['公司', '住宅', '学校', '其它'];
    function getware(){
        activity = api.require('UILoading');
        activity.flower({
            center: {
                x: api.winWidth/2,
                y: api.winHeight/2
            },
            mask:'rgba(20,0,0,0.5)',
            size: 30,
    // fixed: true,

}, function(ret) {
  flowerid1=ret.id;
});
        var now = Date.now();
      //5FB51794-FCDC-1FE9-19E0-xxxxxxxxxxxx换成自己appkey
      var appKey = SHA1("A6099267504667"+"UZ"+"8FC0173C-B395-B797-D516-7A6CD23939B3"+"UZ"+now)+"."+now
      var params={
        fields:{},
        fields: {},
        where: {
            id:api.pageParam.wareId
        },
        skip:0
    }
    params=$api.jsonToStr(params);
    api.ajax({
        url: 'http://d.apicloud.com/mcm/api/ware?filter='+params,
        method: 'get',
        headers: {
            "X-APICloud-AppId": "A6099267504667",
            "X-APICloud-AppKey":   appKey
        },
        
    },function(ret, err){
        if (ret) {
          activity.closeFlower({
            id:flowerid1 
        });
            // 赋值
            jiage=ret[0].price;
            updateWare(ret);
            addInfo.size=api.pageParam.size;
            addInfo.color=api.pageParam.color;
            addInfo.wareid=ret[0].id;
            addInfo.description=ret[0].description;
            addInfo.warename=ret[0].name;
            addInfo.url=ret[0].thumbnail;
            addInfo.shangjia=ret[0].shangjia;
            addInfo.wareTypeId=ret[0].wareTypeId;
            
        } else {
           api.toast({
               msg: err.msg,
               duration: 2000,
               location: 'bottom'
           });
       }
   });

}
function updateWare(_data){
    var warename=$api.byId('warename');
    var wareprice=$api.byId('wareprice');
    var price1=$api.byId('price1');
    
    var image=$api.byId('image');    
    var description=$api.byId('description');
    warename.innerHTML=_data[0].name;
    description.innerHTML=_data[0].description;
    wareprice.innerHTML='￥'+_data[0].price;
    price1.innerHTML='￥'+_data[0].price;
    // price2.innerHTML='￥'+_data[0].price;
    image.src=_data[0].thumbnail;
    vip(_data[0].price);
    
}
function vip(dataprice){
 activity = api.require('UILoading');
   activity.flower({
    center: {
        x: api.winWidth/2,
        y: api.winHeight/2
    },
    mask:'rgba(20,0,0,0.5)',
    size: 30,
    // fixed: true,

}, function(ret) {
  flowerid3=ret.id;
});


 var usernameinfo=$api.getStorage('userInfo');
 var price2=$api.byId('price2');
 price3=$api.byId('price3');
 var now = Date.now();
 var appKey = SHA1("A6099267504667"+"UZ"+"8FC0173C-B395-B797-D516-7A6CD23939B3"+"UZ"+now)+"."+now;
 var params={
    fields: {},
    where:{
        id:usernameinfo.userId
    },
    skip: 0,
}
params=$api.jsonToStr(params);
api.ajax({
    url: 'http://d.apicloud.com/mcm/api/user?filter='+params,
    method: 'get',
    headers: {
        "X-APICloud-AppId": "A6099267504667",
        "X-APICloud-AppKey":   appKey
    },

},function(ret, err){
    if (ret) {
        activity.closeFlower({
            id:flowerid3 
        });
      var viptext=$api.byId('viptext');
      var fanqian=$api.byId('fanqian');
      var vipprice=dataprice * 0.95;
      var ceilprice =Math.round(vipprice);
            // 存储用户名
            // alert($api.jsonToStr(ret))
            if (jiage>29) {


                if (ret[0].vip==1) {

                   viptext.innerHTML='9.5折'+'(-'+(dataprice-ceilprice)+'元)';
                   var fan=Math.round(ceilprice*0.03);
                   price2.innerHTML='￥'+(ceilprice-fan);
                   price3.innerHTML='总金额：'+(ceilprice-fan);
                   fanqian.innerHTML=fan;
                   addInfo.price=ceilprice-fan;
               } else{
                  viptext.innerHTML='分享应用获取vip打9.5折'
                  var fan=Math.round(dataprice*0.03);
                  price2.innerHTML='￥'+(dataprice-fan);
                  price3.innerHTML='总金额：'+(dataprice-fan);
                  fanqian.innerHTML=fan;
                  addInfo.price=dataprice-fan;
              }

          }else{
              viptext.innerHTML='商品价格大于30元即可打折'
              var fan=Math.round(dataprice*0.03);
              price2.innerHTML='￥'+(dataprice-fan);
              price3.innerHTML='总金额：'+(dataprice-fan);
              fanqian.innerHTML=fan;
              addInfo.price=dataprice-fan;

          }
      } else {
        api.toast({
            msg: err.msg,
            duration: 2000,
            location: 'bottom'
        });
    }
});


}
function getaddress(){

   activity = api.require('UILoading');
   activity.flower({
    center: {
        x: api.winWidth/2,
        y: api.winHeight/2
    },
    mask:'rgba(20,0,0,0.5)',
    size: 30,
    // fixed: true,

}, function(ret) {
  flowerid2=ret.id;
});

   var userInfo=$api.getStorage('userInfo');
   var user=$api.getStorage('user');
   addInfo.username=user[0].username
   var now = Date.now();
      //5FB51794-FCDC-1FE9-19E0-xxxxxxxxxxxx换成自己appkey
      var appKey = SHA1("A6099267504667"+"UZ"+"8FC0173C-B395-B797-D516-7A6CD23939B3"+"UZ"+now)+"."+now;
      var params={
       fields: {},
       where: {
        default:1,
        userId:userInfo.userId
    },
    skip: 0
}
params = $api.jsonToStr(params);
api.ajax({
    url: 'http://d.apicloud.com/mcm/api/address?filter='+params,
    method: 'get',
    headers: {
       "X-APICloud-AppId": "A6099267504667",
       "X-APICloud-AppKey":   appKey
   }
},function(ret, err){
    if (ret) {
      activity.closeFlower({
        id:flowerid2 
    });
      dizhinull=ret[0];
      if(ret[0]==null){
        api.toast({
            msg: '请完善收货地址',
            duration: 2000,
            location: 'bottom'
        });

        return;

    }
    updateaddress(ret);
    addInfo.addressid=ret[0].id;
    addInfo.address=ret[0].address;
    addInfo.shoppingname=ret[0].name;
    addInfo.userid=ret[0].userId;
    addInfo.house=ret[0].house;
    addInfo.addresstype=ret[0].type;
    addInfo.mobile=ret[0].mobile; 

} 
}); 
}
function updateaddress(_data){

    var data=$api.jsonToStr(_data);
    
    var shouhuoren=$api.byId('shouhuoren');
    var mobile=$api.byId('mobile');
    var type=$api.byId('type');
    var text=$api.byId('text');
        // alert($api.jsonToStr(_data))
        shouhuoren.innerHTML='收货人:'+_data[0].name;
        mobile.innerHTML=_data[0].mobile;
        type.innerHTML='['+ types[_data[0].type] +']'
        text.innerHTML=_data[0].address+'/'+_data[0].house



    }


    function yesadd(){ 
        if(dizhinull==null){
            api.toast({
                msg: '请完善收货地址',
                duration: 2000,
                location: 'bottom'
            });
            return;

        }
        var now = Date.now();
      //5FB51794-FCDC-1FE9-19E0-xxxxxxxxxxxx换成自己appkey
      var appKey = SHA1("A6099267504667"+"UZ"+"8FC0173C-B395-B797-D516-7A6CD23939B3"+"UZ"+now)+"."+now;
      var userInfo=$api.getStorage('userInfo');
      api.ajax({
        url: 'https://d.apicloud.com/mcm/api/shoppinginformation',
        method: 'post',
        headers: {
           "X-APICloud-AppId": "A6099267504667",
           "X-APICloud-AppKey":   appKey,
           "Authorization": userInfo.id
       },
       data: {
        values: addInfo
    }
}, function(ret, err) {
    if (ret) {

     api.openWin({
         name: 'dindan.html',
         url: './dindan.html',
         pageParam: {
             name: 'test'
         },
         animation: {
             type: "fade"
         }
     });
            // mui.toast('正在生成订单');
               // setTimeout(function(){
                api.closeWin();
               // },1000)


           } 
       });
  }
</script>

</html>
